image: ghcr.io/astral-sh/uv:0.4-python3.10-bookworm-slim


default:
  tags:
    - docker

stages:
  - test
  - deploy


pytest_cov:
  stage: test
  script:
    - uv run pytest --cov=. --cov-report xml src/tests
    - uv run coverage report --include="src/fsl_pipe/*.py"
    - uv run coverage html --include="src/fsl_pipe/*.py"
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    paths:
      - htmlcov
  coverage: '/^TOTAL.+?(\d+\%)$/'


python_version:
  stage: test
  image: ghcr.io/astral-sh/uv:0.4-python$VERSION-bookworm-slim
  script:
    - uv run pytest src/tests
  parallel:
    matrix:
      - VERSION: ["3.10", "3.11", "3.12", "3.13"]

build_test:
  stage: test
  script:
    - apt-get update
    - apt-get install -y git
    - uv run sphinx-multiversion doc/source doc/build
    - uv build

pages:
  stage: deploy
  script:
    - .ci/git_fetch_all.sh
    - uv run sphinx-multiversion doc/source doc/build
    - uv run doc/source/link_stable.py
    - mv doc/build public
    - uv run pytest --cov=. --cov-report xml src/tests
    - uv run coverage html --include="src/fsl_pipe/*.py"
    - mv htmlcov public/.
  artifacts:
    paths:
      - public


to_pypi:
  stage: deploy
  script:
    - uv build
    - uv publish --token ${CI_JOB_TOKEN}
  only:
    - tags