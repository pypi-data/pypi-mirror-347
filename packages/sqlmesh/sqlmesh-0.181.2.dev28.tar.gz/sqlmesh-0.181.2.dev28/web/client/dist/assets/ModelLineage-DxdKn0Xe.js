import{r as o,R as r,j as s,c as D,B as Q,l as P,m as ee,aA as ie,g as le,v as H,b as F,i as U,V as ce,Y as de,aB as ue,t as me,L as te,S as se,D as q,H as fe}from"./index-EyUZDtV7.js";import{d as he,e as ne,f as G,P as ae,h as B,b as $,i as pe,E as W,R as ge,j as we,k as xe,l as ve,m as Y,n as X,o as J,p as ye,q as Ne,r as be,s as Ee}from"./context-DeHggMKx.js";import{W as ke}from"./editor-intN6ort.js";import{F as ze,L as Ce}from"./ListboxShow-CVN-1wre.js";import{S as Me}from"./SearchList-CJR2axiJ.js";import{t as Se}from"./Input-BmfZ-VnW.js";import{U as T}from"./popover-CA0_-cE5.js";import"./_commonjs-dynamic-modules-TDtrdbi3.js";import"./floating-ui.react-dom-dR28niet.js";import"./file-ZamfLSgo.js";import"./project-BX-rNI7d.js";import"./help-6Q7f7fjd.js";import"./SourceList-CXyYEJjr.js";import"./index-BObtdpsN.js";function je({title:e,titleId:t,...n},a){return o.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor","aria-hidden":"true","data-slot":"icon",ref:a,"aria-labelledby":t},n),e?o.createElement("title",{id:t},e):null,o.createElement("path",{fillRule:"evenodd",d:"M10.5 3.75a6.75 6.75 0 1 0 0 13.5 6.75 6.75 0 0 0 0-13.5ZM2.25 10.5a8.25 8.25 0 1 1 14.59 5.28l4.69 4.69a.75.75 0 1 1-1.06 1.06l-4.69-4.69A8.25 8.25 0 0 1 2.25 10.5Z",clipRule:"evenodd"}))}const Le=o.forwardRef(je);function Ie(e,t){if(Object.is(e,t))return!0;if(typeof e!="object"||e===null||typeof t!="object"||t===null)return!1;if(e instanceof Map&&t instanceof Map){if(e.size!==t.size)return!1;for(const[a,d]of e)if(!Object.is(d,t.get(a)))return!1;return!0}if(e instanceof Set&&t instanceof Set){if(e.size!==t.size)return!1;for(const a of e)if(!t.has(a))return!1;return!0}const n=Object.keys(e);if(n.length!==Object.keys(t).length)return!1;for(const a of n)if(!Object.prototype.hasOwnProperty.call(t,a)||!Object.is(e[a],t[a]))return!1;return!0}function He(){return r.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 32 32"},r.createElement("path",{d:"M32 18.133H18.133V32h-4.266V18.133H0v-4.266h13.867V0h4.266v13.867H32z"}))}function Oe(){return r.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 32 5"},r.createElement("path",{d:"M0 0h32v4.2H0z"}))}function Re(){return r.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 32 30"},r.createElement("path",{d:"M3.692 4.63c0-.53.4-.938.939-.938h5.215V0H4.708C2.13 0 0 2.054 0 4.63v5.216h3.692V4.631zM27.354 0h-5.2v3.692h5.17c.53 0 .984.4.984.939v5.215H32V4.631A4.624 4.624 0 0027.354 0zm.954 24.83c0 .532-.4.94-.939.94h-5.215v3.768h5.215c2.577 0 4.631-2.13 4.631-4.707v-5.139h-3.692v5.139zm-23.677.94c-.531 0-.939-.4-.939-.94v-5.138H0v5.139c0 2.577 2.13 4.707 4.708 4.707h5.138V25.77H4.631z"}))}function De(){return r.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 25 32"},r.createElement("path",{d:"M21.333 10.667H19.81V7.619C19.81 3.429 16.38 0 12.19 0 8 0 4.571 3.429 4.571 7.619v3.048H3.048A3.056 3.056 0 000 13.714v15.238A3.056 3.056 0 003.048 32h18.285a3.056 3.056 0 003.048-3.048V13.714a3.056 3.056 0 00-3.048-3.047zM12.19 24.533a3.056 3.056 0 01-3.047-3.047 3.056 3.056 0 013.047-3.048 3.056 3.056 0 013.048 3.048 3.056 3.056 0 01-3.048 3.047zm4.724-13.866H7.467V7.619c0-2.59 2.133-4.724 4.723-4.724 2.591 0 4.724 2.133 4.724 4.724v3.048z"}))}function _e(){return r.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 25 32"},r.createElement("path",{d:"M21.333 10.667H19.81V7.619C19.81 3.429 16.38 0 12.19 0c-4.114 1.828-1.37 2.133.305 2.438 1.676.305 4.42 2.59 4.42 5.181v3.048H3.047A3.056 3.056 0 000 13.714v15.238A3.056 3.056 0 003.048 32h18.285a3.056 3.056 0 003.048-3.048V13.714a3.056 3.056 0 00-3.048-3.047zM12.19 24.533a3.056 3.056 0 01-3.047-3.047 3.056 3.056 0 013.047-3.048 3.056 3.056 0 013.048 3.048 3.056 3.056 0 01-3.048 3.047z"}))}const _=({children:e,className:t,...n})=>r.createElement("button",{type:"button",className:B(["react-flow__controls-button",t]),...n},e);_.displayName="ControlButton";const Fe=e=>({isInteractive:e.nodesDraggable||e.nodesConnectable||e.elementsSelectable,minZoomReached:e.transform[2]<=e.minZoom,maxZoomReached:e.transform[2]>=e.maxZoom}),re=({style:e,showZoom:t=!0,showFitView:n=!0,showInteractive:a=!0,fitViewOptions:d,onZoomIn:i,onZoomOut:l,onFitView:f,onInteractiveChange:h,className:p,children:c,position:N="bottom-left"})=>{const g=he(),[C,k]=o.useState(!1),{isInteractive:w,minZoomReached:x,maxZoomReached:u}=ne(Fe,Ie),{zoomIn:v,zoomOut:E,fitView:m}=G();if(o.useEffect(()=>{k(!0)},[]),!C)return null;const j=()=>{v(),i==null||i()},z=()=>{E(),l==null||l()},S=()=>{m(d),f==null||f()},y=()=>{g.setState({nodesDraggable:!w,nodesConnectable:!w,elementsSelectable:!w}),h==null||h(!w)};return r.createElement(ae,{className:B(["react-flow__controls",p]),position:N,style:e,"data-testid":"rf__controls"},t&&r.createElement(r.Fragment,null,r.createElement(_,{onClick:j,className:"react-flow__controls-zoomin",title:"zoom in","aria-label":"zoom in",disabled:u},r.createElement(He,null)),r.createElement(_,{onClick:z,className:"react-flow__controls-zoomout",title:"zoom out","aria-label":"zoom out",disabled:x},r.createElement(Oe,null))),n&&r.createElement(_,{className:"react-flow__controls-fitview",onClick:S,title:"fit view","aria-label":"fit view"},r.createElement(Re,null)),a&&r.createElement(_,{className:"react-flow__controls-interactive",onClick:y,title:"toggle interactivity","aria-label":"toggle interactivity"},w?r.createElement(_e,null):r.createElement(De,null)),c)};re.displayName="Controls";var $e=o.memo(re);function Ue(e,t){if(Object.is(e,t))return!0;if(typeof e!="object"||e===null||typeof t!="object"||t===null)return!1;if(e instanceof Map&&t instanceof Map){if(e.size!==t.size)return!1;for(const[a,d]of e)if(!Object.is(d,t.get(a)))return!1;return!0}if(e instanceof Set&&t instanceof Set){if(e.size!==t.size)return!1;for(const a of e)if(!t.has(a))return!1;return!0}const n=Object.keys(e);if(n.length!==Object.keys(t).length)return!1;for(const a of n)if(!Object.prototype.hasOwnProperty.call(t,a)||!Object.is(e[a],t[a]))return!1;return!0}var M;(function(e){e.Lines="lines",e.Dots="dots",e.Cross="cross"})(M||(M={}));function Ve({color:e,dimensions:t,lineWidth:n}){return r.createElement("path",{stroke:e,strokeWidth:n,d:`M${t[0]/2} 0 V${t[1]} M0 ${t[1]/2} H${t[0]}`})}function Ae({color:e,radius:t}){return r.createElement("circle",{cx:t,cy:t,r:t,fill:e})}const We={[M.Dots]:"#91919a",[M.Lines]:"#eee",[M.Cross]:"#e2e2e2"},Te={[M.Dots]:1,[M.Lines]:1,[M.Cross]:6},Pe=e=>({transform:e.transform,patternId:`pattern-${e.rfId}`});function oe({id:e,variant:t=M.Dots,gap:n=20,size:a,lineWidth:d=1,offset:i=2,color:l,style:f,className:h}){const p=o.useRef(null),{transform:c,patternId:N}=ne(Pe,Ue),g=l||We[t],C=a||Te[t],k=t===M.Dots,w=t===M.Cross,x=Array.isArray(n)?n:[n,n],u=[x[0]*c[2]||1,x[1]*c[2]||1],v=C*c[2],E=w?[v,v]:u,m=k?[v/i,v/i]:[E[0]/i,E[1]/i];return r.createElement("svg",{className:B(["react-flow__background",h]),style:{...f,position:"absolute",width:"100%",height:"100%",top:0,left:0},ref:p,"data-testid":"rf__background"},r.createElement("pattern",{id:N+e,x:c[0]%u[0],y:c[1]%u[1],width:u[0],height:u[1],patternUnits:"userSpaceOnUse",patternTransform:`translate(-${m[0]},-${m[1]})`},k?r.createElement(Ae,{color:g,radius:v/i}):r.createElement(Ve,{dimensions:E,color:g,lineWidth:d})),r.createElement("rect",{x:"0",y:"0",width:"100%",height:"100%",fill:`url(#${N+e})`}))}oe.displayName="Background";var Ge=o.memo(oe);function Be({handleSelect:e}){const{models:t,lineage:n,mainNode:a,connectedNodes:d}=$(),[i,l]=o.useState(!1),[f,h]=o.useState([]),[p,c]=o.useState(!1);o.useEffect(()=>{h([])},[a,t,n]);function N(){l(!0)}function g(){l(!1)}function C(k){k.length<1||le(f)||H(a)||H(n)||(c(!0),setTimeout(()=>{const w=Array.from(pe(n,a));h(Object.keys(n).map(x=>{var u;return{name:x,displayName:((u=t.get(x))==null?void 0:u.displayName)??decodeURI(x),description:`${w.includes(x)?"Upstream":"Downstream"} | ${d.has(x)?"Directly":"Indirectly"} Connected`}})),c(!1)},300))}return s.jsxs("div",{className:D("w-full",i?"block absolute top-0 left-0 right-0 z-10 pr-10 bg-light dark:bg-dark @[40rem]:items-end @[40rem]:justify-end @[40rem]:flex @[40rem]:static @[40rem]:pr-0":"items-end justify-end flex"),children:[s.jsx(Q,{shape:ie.Circle,className:D("flex @[40rem]:hidden !py-1 border-transparent",i?"hidden":"flex"),variant:ee.Alternative,size:P.sm,"aria-label":"Show search",onClick:N,children:s.jsx(Le,{className:"w-3 h-3 text-primary-500"})}),s.jsx(Me,{list:f,placeholder:"Find",searchBy:"displayName",displayBy:"displayName",direction:"top",descriptionBy:"description",showIndex:!1,size:P.sm,onSelect:e,isLoading:p,className:D("w-full @sm:min-w-[12rem] @[40rem]:flex",i?"flex max-w-none":"hidden max-w-[20rem]"),isFullWidth:!0,onInput:C}),s.jsx("button",{className:D("flex @[40rem]:hidden bg-none border-none px-2 py-1 absolute right-0 top-0",i?"flex":"hidden"),"aria-label":"Hide search",onClick:g,children:s.jsx(ze,{className:"w-6 h-6 text-primary-500"})})]})}function K({nodes:e=[]}){const{setCenter:t}=G(),{activeNodes:n,models:a,mainNode:d,nodesMap:i,selectedNodes:l,setSelectedNodes:f,withImpacted:h,connectedNodes:p,lineageCache:c,setActiveEdges:N,setConnections:g,setLineage:C,setLineageCache:k}=$(),w=H(d)?void 0:a.get(d),x=n.size>0?n.size:p.size,u=l.size,v=p.size-1,E=e.filter(y=>y.hidden).length,m=e.filter(y=>F(y.hidden)&&(y.data.type===W.external||y.data.type===W.seed)).length,j=e.filter(y=>F(y.hidden)&&y.data.type===W.cte).length,z=x>0&&x!==v+1;function S(){if(H(d))return;const y=i[d];H(y)||setTimeout(()=>{t(y.position.x,y.position.y,{zoom:.5,duration:0})},200)}return s.jsxs(s.Fragment,{children:[U(w)&&s.jsx("a",{className:"mr-2 w-full whitespace-nowrap text-ellipsis overflow-hidden @lg:block font-bold text-neutral-600 dark:text-neutral-400 cursor-pointer hover:underline",onClick:S,children:ce(w.displayName,50,25)}),s.jsxs("span",{className:"bg-neutral-5 px-2 py-0.5 flex rounded-full mr-2",children:[s.jsxs("span",{className:"mr-2 whitespace-nowrap block",children:[s.jsx("b",{children:"All:"})," ",e.length]}),E>0&&s.jsxs("span",{className:"whitespace-nowrap block mr-2",children:[s.jsx("b",{children:"Hidden:"})," ",E]}),u>0&&s.jsxs("span",{className:"mr-2 whitespace-nowrap block",children:[s.jsx("b",{children:"Selected:"})," ",u]}),z&&s.jsxs("span",{className:"mr-2 whitespace-nowrap block",children:[s.jsx("b",{children:"Active:"})," ",x]}),(z||u>0||U(c))&&s.jsx(Q,{size:P.xs,variant:ee.Neutral,format:de.Ghost,className:"!m-0 px-1",onClick:()=>{N(new Map),g(new Map),f(new Set),U(c)&&(C(c),k(void 0))},children:"Reset"})]}),m>0&&s.jsxs("span",{className:"mr-2 whitespace-nowrap block",children:[s.jsx("b",{children:"Sources"}),": ",m]}),F(z)&&h&&u===0&&v>0&&s.jsxs("span",{className:"mr-2 whitespace-nowrap block",children:[s.jsx("b",{children:"Upstream/Downstream:"})," ",v]}),j>0&&s.jsxs("span",{className:"mr-2 whitespace-nowrap block",children:[s.jsx("b",{children:"CTEs:"})," ",j]})]})}const Ze=30;function dt({model:e,highlightedNodes:t}){const{setActiveNodes:n,setActiveEdges:a,setConnections:d,setLineage:i,handleError:l,setSelectedNodes:f,setMainNode:h,setWithColumns:p,setHighlightedNodes:c,setNodeConnections:N,setLineageCache:g,setUnknownModels:C,models:k,unknownModels:w}=$(),{refetch:x,isFetching:u,cancel:v}=ue(e.name),{isFetching:E}=me(),[m,j]=o.useState(!1),[z,S]=o.useState(void 0);o.useEffect(()=>{const b=ke();return b.addEventListener("message",y),x().then(({data:L})=>{S(L),!H(L)&&(j(!0),b.postMessage({topic:"lineage",payload:{currentLineage:{},newLineage:L,mainNode:e.fqn}}))}).catch(L=>{l==null||l(L)}).finally(()=>{n(new Set),a(new Map),d(new Map),f(new Set),g(void 0),h(e.fqn)}),()=>{v==null||v(),b.removeEventListener("message",y),b.terminate(),i({}),N({}),h(void 0),c({})}},[e.name,e.hash]),o.useEffect(()=>{Object.keys(z??{}).forEach(b=>{b=encodeURI(b),F(k.has(b))&&F(w.has(b))&&w.add(b)}),C(new Set(w))},[z,k]),o.useEffect(()=>{c(t??{})},[t]);function y(b){var L;b.data.topic==="lineage"&&(j(!1),N(b.data.payload.nodesConnections),i(b.data.payload.lineage),Object.values(((L=b.data.payload)==null?void 0:L.lineage)??{}).length>Ze&&p(!1)),b.data.topic==="error"&&(l==null||l(b.data.error),j(!1))}const O=u||E||m;return s.jsxs("div",{className:"relative h-full w-full overflow-hidden",children:[O&&s.jsxs("div",{className:"absolute top-0 left-0 z-10 flex justify-center items-center w-full h-full",children:[s.jsx("span",{className:"absolute w-full h-full z-10 bg-transparent-20 backdrop-blur-lg"}),s.jsxs(te,{className:"inline-block z-10",children:[s.jsx(se,{className:"w-3 h-3 border border-neutral-10 mr-4"}),s.jsx("h3",{className:"text-md whitespace-nowrap",children:O?"Loading Model's Lineage...":"Merging Model's..."})]})]}),s.jsx(ge,{children:s.jsx(qe,{})})]})}function qe(){const{withColumns:e,lineage:t,mainNode:n,selectedEdges:a,selectedNodes:d,withConnected:i,withImpacted:l,withSecondary:f,hasBackground:h,activeEdges:p,connectedNodes:c,connections:N,nodesMap:g,showControls:C,handleError:k,setActiveNodes:w}=$(),{setCenter:x}=G(),[u,v]=o.useState(!1),E=o.useMemo(()=>({model:we}),[]),m=o.useMemo(()=>xe(t),[t]),j=o.useMemo(()=>ve(t),[t]),[z,S]=o.useState([]),[y,O]=o.useState([]);o.useEffect(()=>{if(q(m)||H(n))return;v(!0);const I=Y(m,p,a,g),V=X(Object.values(g),I,n,c,d,N,i,l,f),A=J(m,N,p,I,a,d,c,i,l,f),Z=ye({nodesMap:g,nodes:V,edges:A});return Z.create().then(R=>{O(R.edges),S(R.nodes)}).catch(R=>{k==null||k(R),O([]),S([])}).finally(()=>{const R=H(n)?void 0:g[n];U(R)&&x(R.position.x,R.position.y,{zoom:.5,duration:0}),setTimeout(()=>{v(!1)},100)}),()=>{Z.terminate(),O([]),S([])}},[p,g,j]),o.useEffect(()=>{if(H(n)||q(z))return;const I=Y(m,p,a,g),V=X(z,I,n,c,d,N,i,l,f),A=J(m,N,p,I,a,d,c,i,l,f);O(A),S(V),w(I)},[N,g,m,p,d,a,c,i,l,f,e,n]);function b(I){S(Ee(I,z))}function L(I){O(be(I,y))}return s.jsxs(s.Fragment,{children:[u&&s.jsxs("div",{className:"absolute top-0 left-0 z-10 flex justify-center items-center w-full h-full",children:[s.jsx("span",{className:"absolute w-full h-full z-10 bg-transparent-20 backdrop-blur-lg"}),s.jsxs(te,{className:"inline-block z-10",children:[s.jsx(se,{className:"w-3 h-3 border border-neutral-10 mr-4"}),s.jsx("h3",{className:"text-md whitespace-nowrap",children:"Building Lineage..."})]})]}),s.jsxs(Ne,{nodes:z,edges:y,nodeTypes:E,onNodesChange:b,onEdgesChange:L,nodeOrigin:[.5,.5],minZoom:.05,maxZoom:1.5,snapGrid:[16,16],snapToGrid:!0,children:[C&&s.jsxs(ae,{position:"top-right",className:"bg-theme !m-0 w-full !z-10",children:[s.jsx(Ye,{nodes:z}),s.jsx(fe,{})]}),s.jsx($e,{className:"bg-light p-1 rounded-md !border-none !shadow-lg"}),s.jsx(Ge,{variant:M.Cross,gap:32,size:4,className:D(h?"opacity-100 stroke-neutral-200 dark:stroke-neutral-800":"opacity-0")})]})]})}function Ye({nodes:e=[]}){const{withColumns:t,mainNode:n,selectedNodes:a,withConnected:d,withImpacted:i,withSecondary:l,hasBackground:f,activeNodes:h,highlightedNodes:p,setSelectedNodes:c,setWithColumns:N,setWithConnected:g,setWithImpacted:C,setWithSecondary:k,setHasBackground:w}=$(),x=o.useRef(null),u=o.useMemo(()=>Object.values(p??{}).flat(),[p]);function v(E){u.includes(E.name)||n===E.name||c(m=>(m.has(E.name)?m.delete(E.name):m.add(E.name),new Set(m)))}return s.jsxs("div",{className:"px-2 flex items-center text-xs text-neutral-400 @container",children:[s.jsxs("div",{className:"contents",children:[s.jsxs(T,{as:"div",className:"flex @lg:hidden bg-none border-none","aria-label":"Show lineage node details",children:[s.jsxs(T.Button,{ref:x,className:"flex items-center relative w-full cursor-pointer bg-primary-10 text-xs rounded-full text-primary-500 py-1 px-3 text-center focus:outline-none focus-visible:border-accent-500 focus-visible:ring-2 focus-visible:ring-light focus-visible:ring-opacity-75 focus-visible:ring-offset-2 focus-visible:ring-offset-brand-300 border-1 border-transparent",children:["Details",s.jsx(Se,{className:"ml-2 h-4 w-4","aria-hidden":"true"})]}),s.jsx(T.Panel,{className:"absolute left-2 right-2 flex-col z-50 mt-8 transform flex px-4 py-3 bg-theme-lighter shadow-xl focus:ring-2 ring-opacity-5 rounded-lg",children:s.jsx(K,{nodes:e})})]}),s.jsx("div",{className:"hidden @lg:contents w-full",children:s.jsx(K,{nodes:e})})]}),s.jsxs("div",{className:"flex w-full justify-end items-center",children:[s.jsx(Be,{handleSelect:v}),s.jsx(Ce,{options:{Background:w,Columns:h.size>0&&a.size===0?void 0:N,Connected:h.size>0?void 0:g,"Upstream/Downstream":h.size>0?void 0:C,All:h.size>0?void 0:k},value:[t&&"Columns",f&&"Background",d&&"Connected",i&&"Upstream/Downstream",l&&"All"].filter(Boolean)})]})]})}export{dt as default};
