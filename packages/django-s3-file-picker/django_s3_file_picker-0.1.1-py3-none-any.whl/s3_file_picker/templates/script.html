<script src="https://storage.yandexcloud.net/bit-static/filebrowser.js"></script>
<script>

function handleFileSelect(key) {
    const input = document.getElementById("{{ widget.attrs.id }}")
    input.value = key
    toggleWindow()
}

function renderFileItem(file, folder_name) {
  const wrapper = document.createElement('div');
  wrapper.className = 'flex justify-between pb-2 hover:bg-gray-500 p-2 rounded';
  wrapper.setAttribute("key", file.key)
    if (file.is_folder) {
        wrapper.setAttribute("onclick", `loadFiles("${file.key}")`)
    }

  const iconHtml = file.is_folder
    ? `<svg xmlns="http://www.w3.org/2000/svg" height="24px" width="24px" viewBox="0 0 24 24" fill="#e8eaed">
         <path d="M0 0h24v24H0V0z" fill="none"/>
         <path d="M9.17 6l2 2H20v10H4V6h5.17M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/>
       </svg>`
    : `<svg xmlns="http://www.w3.org/2000/svg" height="24px" width="24px" viewBox="0 0 24 24" fill="#e8eaed">
         <path d="M0 0h24v24H0V0z" fill="none"/>
         <path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zM6 20V4h7v5h5v11H6z"/>
       </svg>`;
  var keyHtml = ""
  if (file.is_folder) {
      keyHtml = `<div class="align-center">${file.key.replace(folder_name, "")}</div>`;
  }  else {
      keyHtml = `<div class="align-center" onclick='handleFileSelect("${file.key}")'>${file.key.replace(folder_name, "")}</div>`;
  }
  const sizeHtml = `<div><span>${(file.size/1024/1024).toFixed(2)}</span> MB</div>`;
  const actionsHtml = `
  <div class="flex items-center">
        ${sizeHtml}
        <a class="rounded bg-gray-800 p-2 ml-2" href="${file.url}" target="_blank">
            <svg xmlns="http://www.w3.org/2000/svg" enable-background="new 0 0 24 24" height="24px" viewBox="0 0 24 24" width="24px" fill="#e8eaed"><g><rect fill="none" height="24" width="24"/></g><g><path d="M18,15v3H6v-3H4v3c0,1.1,0.9,2,2,2h12c1.1,0,2-0.9,2-2v-3H18z M17,11l-1.41-1.41L13,12.17V4h-2v8.17L8.41,9.59L7,11l5,5 L17,11z"/></g></svg>
        </a>
        <div class="rounded bg-gray-800 p-2 ml-2">
            <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="#e8eaed"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M14.06 9.02l.92.92L5.92 19H5v-.92l9.06-9.06M17.66 3c-.25 0-.51.1-.7.29l-1.83 1.83 3.75 3.75 1.83-1.83c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.2-.2-.45-.29-.71-.29zm-3.6 3.19L3 17.25V21h3.75L17.81 9.94l-3.75-3.75z"/></svg>
        </div>
        <div class="rounded bg-red-500 p-2 ml-2 hover:cursor-pointer" onclick="deleteFile('${file.key}')">
            <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="#e8eaed"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M16 9v10H8V9h8m-1.5-6h-5l-1 1H5v2h14V4h-3.5l-1-1zM18 7H6v12c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7z"/></svg>
        </div>
    </div>
`
  wrapper.innerHTML = `
    <div class="flex flex-row items-center">
     <div class="mr-2 flex align-center">${iconHtml}</div>
     ${keyHtml}
    </div>
    ${file.is_folder ? "" : actionsHtml}
  `;

  return wrapper;
}

function renderFileList(files) {
  const container = document.getElementById('file-list');
  container.innerHTML = ''; // Clear old content
  files.files.forEach(file => {
    const item = renderFileItem(file, files.folder);
    container.appendChild(item);
  });
}



function currentPath() {
    const pathDiv = document.getElementById("fb-path")
    const path = pathDiv.textContent
    const pathSliced = path.split("/")
    return pathSliced.slice(0, pathSliced.length).join("/")
}

function updatePath(value) {
    const pathDiv = document.getElementById("fb-path")
    pathDiv.innerHTML = ""
    const pathSliced = value.split("/")
    var key = ""
    pathSliced.slice(0, pathSliced.length - 1).forEach((pathPart) => {
        const pathPartDiv = document.createElement('div');
        pathPartDiv.className = "hover:underline hover:cursor-pointer"
        pathPartDiv.innerText = pathPart
        key += pathPart + "/"
        pathPartDiv.setAttribute("onclick", `loadFiles("${key}")`)
        pathDiv.append(pathPartDiv)
        pathDiv.append("/")
    })
}

function loadBack() {
    const pathDiv = document.getElementById("fb-path")
    const path = pathDiv.textContent
    const pathSliced = path.split("/")
    if (pathSliced.length > 2) {
        const folder = pathSliced.slice(0, pathSliced.length - 2).join("/") + "/"
        loadFiles(folder)
    }
}


loadFiles("sohin/")



function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
      cookie = cookie.trim();
      if (cookie.startsWith(name + '=')) {
        cookieValue = decodeURIComponent(cookie.slice(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

function openFilePicker(callback) {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '*/*'; // or e.g. 'image/*', 'application/pdf'
  input.onchange = () => callback(input.files[0]);
  input.click();
}

function handleOpenFilePicker() {
    openFilePicker((file) => {
        uploadFile(file)
    })
}

function toggleWindow() {
    const dropzone = document.getElementById("dropzone")

    if (dropzone.className.includes("hidden")) {
        dropzone.className = dropzone.className.replace("hidden ", "")
    } else {
        dropzone.className = "hidden " + dropzone.className
    }
}

</script>
