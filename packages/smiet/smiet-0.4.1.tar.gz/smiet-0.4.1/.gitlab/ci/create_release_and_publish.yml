# If the test pass and a tag was created, make a release in the repo
release_job:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  # Run this job when a tag is created
  rules:
    - if: $CI_COMMIT_TAG
  script:
    - echo "running release_job"
  release:                               # See https://docs.gitlab.com/ee/ci/yaml/#release for available properties
    tag_name: '$CI_COMMIT_TAG'
    description: '$CI_COMMIT_TAG'
  
# Publish on PyPi when creating a tag and release was made
pypi-release:
  needs:
    - release_job
  stage: publish
  rules:
    - if: $CI_COMMIT_TAG
  environment:
    name: 'release-test'
    url: 'https://pypi.org/project/smiet/'
  script:
    - pip install build twine
    - python -m build
    - python -m twine upload dist/* --verbose --non-interactive --password $PYPI_API_TOKEN