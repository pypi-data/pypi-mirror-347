// ------------------------------------------------------------------------------------------------------        
//
// OKNDETECTOR 
//
// version 2.0  Gaze Template 
//
// Author: Jason Turuwhenua, modified: 16/10/21
//
// ---------------------------------------------------------------------------------------------------------*/


{


            // FPS information 


            "fps" : {   "method" : "constant", 
                        "value"  : 50 },


            // REMAPPER When a data record is read in, the column headers for the CSV file are remapped internally to the 
            // following fields (t,x,y,v,c,e) 
            //
            // The internal fields are :
            // 
            // INPUT
            //
            //  t is the time time field 
            //  x is the horizontal displacement 
            //  y is the vertical displacement 
            //  v is the horizontal velocity 
            //  c is the confidence (e.g., pupil labs)
            //  e is the stimulus direction 
            //
            // OUTPUT 
            //
            // The internal fields are then mapped, for every input record, to an associated OUTPUT record. 
            // These fields are specified below under "output" and should not be MODIFIED
            //


            // The filter option below will process data for the named Tile only 
            // We could instead pass this string on the command-line


            "remapper" : {  "input"   : { "t":   "Number(record.record_timestamp)", 
                                           "x":  "Number(record.updated_x_nom)",
                                           "y":  "Number(record.updated_y_nom)",
                                           "v":  "Number(record.updated_dXdt_nom)",
                                           "c":  "Number(1.0)",                                                        
                                           "e":  "Number(record.direction)",
                                           "s":  "Number(record.sensor_timestamp)"},

                             "output" : {  "id"                             : "data.counter", 
                                           "t"                              : "data.t", 
                                           "s"                              : "data.s",
                                           "x"                              : "data.x",
                                           "y"                              : "data.y",
                                           "v"                              : "data.v",
                                           "e"                              : "data.e",            // shown  direction                                            
                                           "e1"                             : "data.e1",           // tested direction                                            
                                           "t_local"                        : "data.t_local",
                                           "blink"                          : "data.blink",
                                           "plateau"                        : "data.plateau",                                                                                      
                                           "state"                          : "data.state",
                                           "ramp_direction"                 : "data.ramp_direction",
                                           "sp_start_time"                  : "data.sp_start_time",
                                           "sp_end_time"                    : "data.sp_end_time",
                                           "sp_start_displacement"          : "data.sp_start_displacement",
                                           "sp_end_displacement"            : "data.sp_end_displacement",
                                           "sp_duration"                    : "data.sp_duration",
                                           "qp_start_time"                  : "data.qp_start_time",
                                           "qp_end_time"                    : "data.qp_end_time",
                                           "qp_start_displacement"          : "data.qp_start_displacement",
                                           "qp_end_displacement"            : "data.qp_end_displacement",
                                           "qp_duration"                    : "data.qp_duration",
                                           "chain_id"                       : "data.chain_id",
                                           "expected_sp_ramp_direction"     : "data.expected_sp_ramp_direction",
                                           "expected_qp_ramp_direction"     : "data.expected_qp_ramp_direction",
                                           "expected_qp_peak_velocity"      : "data.expected_qp_peak_velocity",
                                           "expected_sp_end_peak_type"      : "data.expected_sp_end_peak_type",
                                           "expected_qp_end_peak_type"      : "data.expected_qp_end_peak_type",
                                           "expected_sp_end_bound"          : "data.expected_sp_end_bound" }
                                           
                        },



            // MAIN OKNDETECTION PARAMETERS.  The following sections are used to used to adjust the performance of the OKNDETECTOR 
            // The components listed below are 
            //
            // 1 - Smoothing         : the input data can be smoothed [NOT RECOMMENDED]
            // 2 - ramping           : the method used to indicate a ramp or SP 
            // 3 - stimulusMonitor   : the source for stimulus direction (can be forced/overriden by the -d switch on the command-line)
            // 4 - stationaryMonitor : records region of stationary-data. This is used for monitoring purposes only [DEPRECATING]
            // 5 - peakDetector      : Used to identify peaks (Not sure what the purpose is)
            // 6 - detector          : Parameters used to REJECT a candidate 
            //
            // Please see following SECTIONS for main information


            // 1. SMOOTHING Smooth the incoming signal [ NOT RECOMMENDED ]
            //
            // Not recommended to be done from wihtin the program. Smoothing will introduce lag and tend to smooth discontinuities (e.g., quick phase) 
            //
            // default : FALSE

            "smoothing" : {   "enabled"     : false,
                              "name"        : "savitzky-golay",
                              "framelength" : 21, 
                              "polyorder"   : 3 },


            // 2. RAMPING The Slow-Phase (SP) detection method  
            //
            //    DIRECT no processing applied  

            "ramping" : {   "method"              : "MEDIAN",
                            "framelength"         : 3,
                            "threshold"           : 0.05,
                            "threshold-method"    : "blind" },



            // 3. STIMULUSMONITOR The stimulus monitor is used to define the direction of the stimulus for a given data point
            //
            // The stimulusMonitor below uses the value of the INTERNAL 'data.e' column to determine the direction of the stimulus 
            // This will be -1 for a DOWN and +1 for UP

            "stimulusMonitor" : {   "enable"   : true,
                                    "method"   : "function",
                                    "value"    : "Number(data.e)",
                                    "file"     : ""
            },


            // 4. STATIONARITYMONITOR Tolerance to low/counter velocity regions (IS IT IMPLEMENTED?)
            //
            // Implemented but takes no action other than recording data (TO BE REMOVED)

            "stationarityMonitor" : { "enable"                 : true,
                                      "method"                 : "velocity",
                                      "max_tolerated_duration" : 0.1, 
                                      "max_tolerated_velocity" : 5
            },


            // 5. PEAKDETECTOR Peak detection
            //
            // NOT IMPLEMENTED AS FAR AS I CAN TELL 
            //


            "peakDetector" :  { "enable": true, "minimum_velocity_amplitude" : 10 },


            // BLINK_DETECTOR Blink detection 
            //
            //
            //
            //

            "blink_detector" : {    "enabled"   : true,                      // always runs, this flag determines if action will be taken
                                    "desc"      : "blink detection",
                                    "method"    : "corr-wavepacket",
                                    "duration"  : 0.22,						 // This is the change 
                                    "threshold" : 0.75,
                                    "factor"    : 0.05,
                                    "action"    : "reset" },


            // PLATEAUDETECTOR Blink detection 
            //
            //
            //
            //

            "plateau_detector" : {    "enabled"   : true,                   // always runs, this flag determines if action will be taken
                                      "desc"      : "plateau detection",
                                      "method"    : "velocity-consensus",
                                      "threshold" : 0.02,
                                      "consensus" : 1.0,    
                                      "duration"  : 0.15 },   


            // 6. DETECTOR Threshold parameters applied to candidates that are detected as OKN 
            //
            //  1 - Slow and quick phase duration 
            //  2 - Slow and quick phase amplitudes  
            //  3 - Slow and quick velocity         velocity_thresholding is it USED?             
            //  4 - Allow a bumpy slow phase 
            //  5 - Blink Detection                 SHOULD BE REMOVED 
            //  6 - Tolerate Bumps                  CONFLICTING WITH 4 
            //  7 - Stationarity monitor            NOT USED 






            "detector" : {    // 1 - Slow and quick phase duration 

                              "slow_phase_duration_check"   : { "enable" : true,  "lower" : 0.10,  "upper" : 3.0 },
                              "quick_phase_duration_check"  : { "enable" : true,  "lower" : 0.00,  "upper" : 0.2 },           

                              // 2 - Slow and quick phase amplitudes  

                              "slow_phase_amplitude_check"   : { "enable" : true, "lower" : 0.005, "upper" : 0.15 },
                              "quick_phase_amplitude_check"  : { "enable" : true, "lower" : 0.005, "upper" : 0.20 },

                              // 3 - Slow and quick velocity         velocity_thresholding is it USED?                                

                              "velocity_thresholding"        : true,
                              "slow_phase_velocity_check"    : { "enable" : true, "lower" : 0.0, "upper" : 0.2 },
                              "quick_phase_velocity_check"   : { "enable" : true, "lower" : 0.0, "upper" : 10.0 },


                              // 4 -  Quick amplitude to slow amplitude ratio check QP/SP  (e.g., 4 upper limit means QP < 4x  the SP amplitude )

                              "quick_slow_amp_ratio_check"    : { "enable" : true, "lower" : 0, "upper" : 3 },


                              // 5 - Allow a bumpy slow phase (this will tolerate a RAMP that is INDETERMINATE see the Ramping SECTION)
                              //     This could probably be shifted to ramping component

                              "tolerate_slow_phase_bumps"    : { "enable" : true },

                              //
                              // The following are UNUSED or TO BE REMOVED fields
                              //


                              // 5 - Blink Detection [SHOULD BE REMOVED]

                              "use_blink_detection"    : false,
                              "method"                 : "confidence",
                              "blink_limits"           : { "lower" : 0.4, "upper" : 0.8 },
                              "blink_lead_lag_time"    : 0.1,

                              // 6 - Tolerate Bumps [CONFLICTING WITH 4] [DEPRECATE - UNUSED]

                              "tolerate_bumps"         : { "enable" : true,  "max_duration" : 0.1, "max_velocity" : 0.5 }, 

                              // 7 - Stationarity monitor [NOT USED] 

                              "use_stationarity_monitor" : false,
                              "stationarity_check"       : { "enable" : true, "max_proportion" : 0.5, "max_velocity" : 1 },                              
                              "stationarity_duration"         : 0.05,
                              "stationarity_threshold"        : 1,
                              "stationarity_maximum_velocity" : 1,
                              "stationarity_sp_tolerance"     : 0.3

                        }
}
 