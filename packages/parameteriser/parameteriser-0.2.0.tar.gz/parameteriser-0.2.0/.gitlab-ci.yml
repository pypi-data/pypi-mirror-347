stages:
  - lint
  - test
  - build

variables:
  UV_VERSION: 0.5.11
  UV_CACHE_DIR: .uv-cache
  PYTHON_VERSION: 3.11
  BASE_LAYER: bookworm-slim
  JUPYTER_PLATFORM_DIRS: 1

image: ghcr.io/astral-sh/uv:$UV_VERSION-python$PYTHON_VERSION-$BASE_LAYER

lint:
  stage: lint
  cache:
    - key:
        files:
          - uv.lock
      paths:
        - $UV_CACHE_DIR
  script:
    - uv sync --extra dev
    - uv run ruff format src/
    - uv run ruff check src/
    - uv cache prune --ci
  except:
    - merge_requests
    - main

test:
  stage: test
  cache:
    - key:
        files:
          - uv.lock
      paths:
        - $UV_CACHE_DIR
  script:
    - uv sync --extra dev
    - uv run pytest --cov tests/
    - uv cache prune --ci
  coverage: "/TOTAL.+ ([0-9]{1,3}%)/"
  only:
    - merge_requests
    - main # if i push directly and for coverage badge


pages:
  allow_failure: true
  stage: build
  script:
    - uv sync --extra dev
    - uv run mkdocs build --strict --verbose
  artifacts:
    paths:
      - public
  only:
    - main

# build:
#   stage: build
#   script:
#     - uv build
#     - uv publish
#   rules:
#     - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
#       changes:
#         - pyproject.toml
