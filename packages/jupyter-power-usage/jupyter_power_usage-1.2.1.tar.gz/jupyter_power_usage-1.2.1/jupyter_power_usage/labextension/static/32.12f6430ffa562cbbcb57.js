"use strict";(self.webpackChunk_mahendrapaipuri_jupyter_power_usage=self.webpackChunk_mahendrapaipuri_jupyter_power_usage||[]).push([[32],{32:(e,t,n)=>{n.r(t),n.d(t,{default:()=>J});var r=n(40),s=n(780),i=n(834),a=n(29),o=n.n(a),c=n(496);function l(e,t){return e>.5?e>.8?"red":"orange":t}const u=({percentage:e,color:t})=>o().createElement("div",{className:"jp-IndicatorFiller",style:{width:100*e+"%",background:`${t}`}}),p=({values:e,percentage:t,baseColor:n})=>{const[r,s]=(0,a.useState)(!1),i=l(t,n);return o().createElement("div",{className:"jp-IndicatorBar",onClick:()=>{s(!r)}},r&&o().createElement(c.Sparklines,{data:e,min:0,max:1,limit:e.length,margin:0},o().createElement(c.SparklinesLine,{style:{stroke:i,strokeWidth:4,fill:i,fillOpacity:1}}),o().createElement(c.SparklinesSpots,null)),!r&&o().createElement(u,{percentage:t,color:i}))},d=({enabled:e,indicatorBarEnabled:t,values:n,label:r,color:s,text:i})=>{const a=n[n.length-1],c=l(a,s);return e&&o().createElement("div",{className:"jp-IndicatorContainer"},o().createElement("div",{className:"jp-IndicatorText"},r),null!==a&&t&&o().createElement("div",{className:"jp-IndicatorWrapper"},o().createElement(p,{values:n,percentage:a,baseColor:s})),o().createElement("div",{className:"jp-IndicatorText",style:{color:!t&&c}},i))},h=({model:e,indicatorBarEnabled:t,label:n})=>{const[r,s]=(0,a.useState)(""),[i,c]=(0,a.useState)([]),l=()=>{const{currentCpuPower:t,currentCpuPowerLimit:n}=e,r=`${t.toFixed(2)} ${n?"/ "+n.toFixed(0):""} W`,i=e.values.map((e=>e.cpuPowerShare));s(r),c(i)};return(0,a.useEffect)((()=>(e.changed.connect(l),()=>{e.changed.disconnect(l)})),[e]),o().createElement(d,{enabled:e.cpuPowerAvailable,indicatorBarEnabled:t,values:i,label:n,color:"#1AB7AE",text:r})};var m;!function(e){e.createPowerView=(e,t,n)=>s.ReactWidget.create(o().createElement(h,{model:e,indicatorBarEnabled:t,label:n}))}(m||(m={}));const g=({model:e,indicatorBarEnabled:t,label:n})=>{const[r,s]=(0,a.useState)(""),[i,c]=(0,a.useState)([]),l=()=>{const{currentGpuPower:t,currentGpuLimit:n}=e,r=`${t.toFixed(2)} ${n?"/ "+n.toFixed(0):""} W`,i=e.values.map((e=>e.gpuPowerShare));s(r),c(i)};return(0,a.useEffect)((()=>(e.changed.connect(l),()=>{e.changed.disconnect(l)})),[e]),o().createElement(d,{enabled:e.gpuPowerAvailable,indicatorBarEnabled:t,values:i,label:n,color:"#76B900",text:r})};var f;!function(e){e.createPowerView=(e,t,n)=>s.ReactWidget.create(o().createElement(g,{model:e,indicatorBarEnabled:t,label:n}))}(f||(f={}));const v=({enabled:e,text:t})=>e&&o().createElement("div",{className:"jp-IndicatorContainer"},o().createElement("div",{className:"jp-IndicatorText"},o().createElement("span",null,"eCO",o().createElement("sub",null,"2"),":")),o().createElement("div",{className:"jp-IndicatorText"},t)),w=({model:e})=>{const[t,n]=(0,a.useState)(""),r=()=>{const{currentEmissions:t,emissionsUnits:r}=e,s=["mg","g","kg"].indexOf(r)>0?0:2,i=`${t.toFixed(s)} ${e.emissionsUnits}`;n(i)};return(0,a.useEffect)((()=>(e.changed.connect(r),()=>{e.changed.disconnect(r)})),[e]),o().createElement(v,{enabled:e.emissionsAvailable,text:t})};var _;!function(e){e.createEmissionsView=e=>s.ReactWidget.create(o().createElement(w,{model:e}))}(_||(_={}));var b=n(571),y=n(393),E=n(797),P=n(901);const x=1e3,A=1e6;var C,F;!function(e){e.getOpenDataSoftEmissionFactor=async()=>{var e,t;const n={dataset:"eco2mix-national-tr",facet:"date_heure",start:"0",rows:"1",sort:"date_heure",timezone:"Europe/Paris",q:`date_heure:[${(new Date).toISOString().split("T")[0]} TO #now()] AND NOT #null(taux_co2)`},r=b.URLExt.objectToQueryString(n),s=b.URLExt.join("https://odre.opendatasoft.com","/api/records/1.0/search/",r);try{const n=await fetch(s,{method:"GET"});if(!n.ok)return console.debug("Request to Opendatasoft API failed"),null;const r=await n.json();if(r&&r.records&&r.records.length>0)return(null===(t=null===(e=r.records[0])||void 0===e?void 0:e.fields)||void 0===t?void 0:t.taux_co2)||0}catch(e){return console.info(`Request to Opendatasoft API failed due to ${e}`),null}return null}}(C||(C={})),function(e){const t="/v3/carbon-intensity/latest",n=y.ServerConnection.makeSettings();e.getElectricityMapsEmissionFactor=async(e,r,s)=>{const i={zone:s.toUpperCase()},a=b.URLExt.objectToQueryString(i);try{let s;const i=new Headers;r.length>0&&i.set("auth-token",r),s=e?b.URLExt.join(n.baseUrl,"api/metrics/v1/emission_factor/emaps",t,a):b.URLExt.join("https://api.electricitymap.org",t,a);const o=await fetch(s,{method:"GET",headers:i});if(!o.ok)return console.debug("Request to Electricity Maps API failed"),null;const c=await o.json();if(c&&c.carbonIntensity)return c.carbonIntensity||0}catch(e){return console.info(`Request to Electricity Maps failed due to ${e}`),null}return null}}(F||(F={}));const U=async function(e,t,n,r){return"rte"===e?await C.getOpenDataSoftEmissionFactor():"emaps"===e?await F.getElectricityMapsEmissionFactor(t,n.emaps,r):null};var S,j,k;!function(e){class t extends s.VDomModel{constructor(e,t){super(),this._cpuPowerUsageAvailable=!1,this._gpuPowerUsageAvailable=!1,this._emissionsAvailable=!1,this._currentCpuPowerLimit=null,this._currentCpuPowerUsage=null,this._currentGpuPowerUsage=null,this._currentGpuPowerLimit=null,this._currentEmissions=null,this._lastEmissionReading=Date.now(),this._lastEmissionFactor=null,this._totalEmissions=0,this._values=[],this._emissionModel=e;for(let e=0;e<20;e++)this._values.push({cpuPowerShare:0,gpuPowerShare:0});this._poll=new E.Poll({factory:()=>k.powerUsageFactory(),frequency:{interval:t.refreshRate,backoff:!0,max:3e5},name:"jupyter-power-usage:PowerUsage#metrics",standby:t.refreshStandby||"when-hidden"}),this._poll.ticked.connect((e=>{const{payload:t,phase:n}=e.state;if("resolved"!==n){if("rejected"===n){const e=this._cpuPowerUsageAvailable;return this._cpuPowerUsageAvailable=!1,this._gpuPowerUsageAvailable=!1,this._emissionsAvailable=!1,this._currentCpuPowerLimit=null,this._currentCpuPowerUsage=null,this._currentGpuPowerUsage=null,this._currentGpuPowerLimit=null,this._currentEmissions=null,void(e&&this.stateChanged.emit())}}else this._updateMetricsValues(t)}))}async refresh(){await this._poll.refresh(),await this._poll.tick}get cpuPowerAvailable(){return this._cpuPowerUsageAvailable}get gpuPowerAvailable(){return this._gpuPowerUsageAvailable}get emissionsAvailable(){return this._emissionsAvailable&&(this._cpuPowerUsageAvailable||this._gpuPowerUsageAvailable)}get currentCpuPower(){return this._currentCpuPowerUsage}get currentCpuPowerLimit(){return this._currentCpuPowerLimit}get currentGpuPower(){return this._currentGpuPowerUsage}get currentGpuLimit(){return this._currentGpuPowerLimit}get currentEmissions(){return this._currentEmissions}get totalEmissions(){return this._totalEmissions}get emissionsUnits(){return this._emissionsUnits}get changed(){return this.stateChanged}get values(){return this._values}dispose(){this._poll.dispose()}_updateMetricsValues(e){if(null===e)return this._cpuPowerUsageAvailable=!1,this._gpuPowerUsageAvailable=!1,this._emissionsAvailable=!1,this._currentCpuPowerLimit=null,this._currentCpuPowerUsage=null,this._currentGpuPowerUsage=null,this._currentGpuPowerLimit=null,void(this._currentEmissions=null);const t=e.cpu?e.cpu.usage:null,n=e.cpu?e.cpu.limit:null;this._cpuPowerUsageAvailable=!!t,this._currentCpuPowerUsage=t,this._currentCpuPowerLimit=n;const r=e.gpu?e.gpu.usage:null,s=e.gpu?e.gpu.limit:null;this._gpuPowerUsageAvailable=!!r,this._currentGpuPowerUsage=r,this._currentGpuPowerLimit=s;const{emissionFactorAvailable:i,currentEmissionFactor:a}=this._emissionModel;if(this._lastEmissionFactor=i?a:this._lastEmissionFactor,this._emissionsAvailable=null!==this._lastEmissionFactor,this._emissionsAvailable){const e=Date.now()-this._lastEmissionReading,n=(t||0)+(r||0),s=this._lastEmissionFactor*n*e/1e3;this._lastEmissionReading=Date.now();const i=this._totalEmissions+s,[a,c]=(o=i)?o<x?[o,"mg"]:x===o||o<A?[o/x,"g"]:[o/A,"kg"]:[0,"mg"];this._currentEmissions=a,this._emissionsUnits=c,this._totalEmissions=i}var o;const c=this._currentCpuPowerLimit?Math.min(this._currentCpuPowerUsage/this._currentCpuPowerLimit,1):null,l=this._currentGpuPowerUsage&&this._currentGpuPowerLimit?Math.min(this._currentGpuPowerUsage/this._currentGpuPowerLimit,1):null;this._values.push({cpuPowerShare:c,gpuPowerShare:l}),this._values.shift(),this.stateChanged.emit(void 0)}}e.Model=t}(S||(S={})),function(e){e.Model=class{constructor(e){this._emissionFactorAvailable=!1,this._useProxy=!1,this._currentEmissionFactor=null,this._changed=new P.Signal(this),"emaps"===e.emissionFactorSource&&new Promise((()=>{U(e.emissionFactorSource,!0,e.accessTokens,e.countryCode).then((e=>{this._useProxy=!!e})).catch((()=>{console.warn("Emission factor from Electricity maps will be fetched by making API requests directly from the browser. If a access token has been set, this can pose security risks. Please configure the access token on Jupyter server extension."),this._useProxy=!1}))})),this._poll=new E.Poll({factory:()=>k.emissionsFactory(e.emissionFactorSource,this._useProxy,e.accessTokens,e.countryCode,e.defaultEmissionFactor),frequency:{interval:e.refreshRate,backoff:!0,max:3e5},name:"jupyter-power-usage:EmissionFactor#metrics",standby:e.refreshStandby||"when-hidden"}),this._poll.ticked.connect((e=>{const{payload:t,phase:n}=e.state;if("resolved"!==n){if("rejected"===n){const e=this._emissionFactorAvailable;return this._emissionFactorAvailable=!1,this._currentEmissionFactor=null,void(e&&this._changed.emit())}}else this._updateMetricsValues(t)}))}async refresh(){await this._poll.refresh(),await this._poll.tick}get emissionFactorAvailable(){return this._emissionFactorAvailable}get currentEmissionFactor(){return this._currentEmissionFactor}dispose(){this._poll.dispose()}_updateMetricsValues(e){if(null===e)return this._emissionFactorAvailable=!1,void(this._currentEmissionFactor=null);const t=e;this._emissionFactorAvailable=null!==t,this._currentEmissionFactor=t,this._changed.emit(void 0)}}}(j||(j={})),function(e){const t=y.ServerConnection.makeSettings(),n=b.URLExt.join(t.baseUrl,"api/metrics/v1/power_usage");e.powerUsageFactory=async()=>{const e=y.ServerConnection.makeRequest(n,{},t),r=await e;return r.ok?await r.json():null},e.emissionsFactory=async(e,t,n,r,s)=>{const i=await U(e,t,n,r);return i?i/3600:s/3600}}(k||(k={}));var I=n(379),T=n.n(I),L=n(795),R=n.n(L),M=n(569),G=n.n(M),B=n(565),N=n.n(B),q=n(216),O=n.n(q),V=n(589),D=n.n(V),$=n(760),W={};W.styleTagTransform=D(),W.setAttributes=N(),W.insert=G().bind(null,"head"),W.domAPI=R(),W.insertStyleElement=O(),T()($.Z,W),$.Z&&$.Z.locals&&$.Z.locals;const Z=5e3,z=18e5,H={id:"@mahendrapaipuri/jupyter-power-usage:plugin",autoStart:!0,requires:[s.IToolbarWidgetRegistry],optional:[i.ISettingRegistry,r.JupyterLab.IInfo],activate:async(e,t,n,r)=>{console.log("@mahendrapaipuri/jupyter-power-usage extension is activated");let s=Z,i=!1,a="CPU Power: ",o="GPU Power: ",c=z,l="rte",u="",p="fr",d=475;if(n){const e=await n.load(H.id);s=e.get("refreshRate").composite,s<Z&&(console.log("Refresh rate is floored at 5000 ms"),s=Z),i=e.get("indicatorBarDisabled").composite;const t=e.get("emissions").composite;l=t.source,u=t.emapsAccessToken,p=t.countryCode,c=t.refreshRate,d=t.factor,c<z&&(console.log("Emissions update interval is floored at 1800000 ms"),c=z);const r=e.get("cpu").composite;a=r.label;const h=e.get("gpu").composite;o=h.label}const h=new j.Model({refreshRate:c,emissionFactorSource:l,accessTokens:{emaps:u},countryCode:p,defaultEmissionFactor:d,refreshStandby:()=>r&&!r.isConnected||"when-hidden"});await h.refresh();const g=new S.Model(h,{refreshRate:s,refreshStandby:()=>r&&!r.isConnected||"when-hidden"});await g.refresh(),g.cpuPowerAvailable||g.gpuPowerAvailable||(console.log("Power metrics are not available..."),g.dispose(),h.dispose()),g.cpuPowerAvailable&&t.addFactory("TopBar","cpu_power",(()=>m.createPowerView(g,!i,a))),g.gpuPowerAvailable&&t.addFactory("TopBar","gpu_power",(()=>f.createPowerView(g,!i,o))),g.emissionsAvailable&&t.addFactory("TopBar","emissions",(()=>_.createEmissionsView(g)))}},J=H},150:(e,t,n)=>{n.d(t,{Z:()=>o});var r=n(81),s=n.n(r),i=n(645),a=n.n(i)()(s());a.push([e.id,".jp-IndicatorContainer {\n  display: flex;\n  flex-direction: row;\n}\n\n.jp-IndicatorFiller {\n  height: 100%;\n}\n\n.jp-IndicatorText {\n  display: flex;\n  min-width: 35px;\n  flex-direction: column;\n  justify-content: center;\n  text-align: right;\n  white-space: nowrap;\n  overflow: hidden;\n}\n\n.jp-IndicatorWrapper {\n  display: flex;\n  flex-direction: column;\n  justify-content: center;\n  margin-left: 5px;\n  margin-right: 5px;\n  width: 75px;\n}\n\n.jp-IndicatorBar {\n  height: 75%;\n  outline: 1px solid black;\n}\n\n.jp-IndicatorBar svg {\n  max-width: 100%;\n  height: 100%;\n}\n\n/* To center the subscript in the text */\nsub {\n  top: 0;\n  bottom: 0;\n  line-height: 1;\n  font-size: 0.5em;\n}\n",""]);const o=a},760:(e,t,n)=>{n.d(t,{Z:()=>l});var r=n(81),s=n.n(r),i=n(645),a=n.n(i),o=n(150),c=a()(s());c.i(o.Z),c.push([e.id,"\n",""]);const l=c},645:e=>{e.exports=function(e){var t=[];return t.toString=function(){return this.map((function(t){var n="",r=void 0!==t[5];return t[4]&&(n+="@supports (".concat(t[4],") {")),t[2]&&(n+="@media ".concat(t[2]," {")),r&&(n+="@layer".concat(t[5].length>0?" ".concat(t[5]):""," {")),n+=e(t),r&&(n+="}"),t[2]&&(n+="}"),t[4]&&(n+="}"),n})).join("")},t.i=function(e,n,r,s,i){"string"==typeof e&&(e=[[null,e,void 0]]);var a={};if(r)for(var o=0;o<this.length;o++){var c=this[o][0];null!=c&&(a[c]=!0)}for(var l=0;l<e.length;l++){var u=[].concat(e[l]);r&&a[u[0]]||(void 0!==i&&(void 0===u[5]||(u[1]="@layer".concat(u[5].length>0?" ".concat(u[5]):""," {").concat(u[1],"}")),u[5]=i),n&&(u[2]?(u[1]="@media ".concat(u[2]," {").concat(u[1],"}"),u[2]=n):u[2]=n),s&&(u[4]?(u[1]="@supports (".concat(u[4],") {").concat(u[1],"}"),u[4]=s):u[4]="".concat(s)),t.push(u))}},t}},81:e=>{e.exports=function(e){return e[1]}},379:e=>{var t=[];function n(e){for(var n=-1,r=0;r<t.length;r++)if(t[r].identifier===e){n=r;break}return n}function r(e,r){for(var i={},a=[],o=0;o<e.length;o++){var c=e[o],l=r.base?c[0]+r.base:c[0],u=i[l]||0,p="".concat(l," ").concat(u);i[l]=u+1;var d=n(p),h={css:c[1],media:c[2],sourceMap:c[3],supports:c[4],layer:c[5]};if(-1!==d)t[d].references++,t[d].updater(h);else{var m=s(h,r);r.byIndex=o,t.splice(o,0,{identifier:p,updater:m,references:1})}a.push(p)}return a}function s(e,t){var n=t.domAPI(t);return n.update(e),function(t){if(t){if(t.css===e.css&&t.media===e.media&&t.sourceMap===e.sourceMap&&t.supports===e.supports&&t.layer===e.layer)return;n.update(e=t)}else n.remove()}}e.exports=function(e,s){var i=r(e=e||[],s=s||{});return function(e){e=e||[];for(var a=0;a<i.length;a++){var o=n(i[a]);t[o].references--}for(var c=r(e,s),l=0;l<i.length;l++){var u=n(i[l]);0===t[u].references&&(t[u].updater(),t.splice(u,1))}i=c}}},569:e=>{var t={};e.exports=function(e,n){var r=function(e){if(void 0===t[e]){var n=document.querySelector(e);if(window.HTMLIFrameElement&&n instanceof window.HTMLIFrameElement)try{n=n.contentDocument.head}catch(e){n=null}t[e]=n}return t[e]}(e);if(!r)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");r.appendChild(n)}},216:e=>{e.exports=function(e){var t=document.createElement("style");return e.setAttributes(t,e.attributes),e.insert(t,e.options),t}},565:(e,t,n)=>{e.exports=function(e){var t=n.nc;t&&e.setAttribute("nonce",t)}},795:e=>{e.exports=function(e){if("undefined"==typeof document)return{update:function(){},remove:function(){}};var t=e.insertStyleElement(e);return{update:function(n){!function(e,t,n){var r="";n.supports&&(r+="@supports (".concat(n.supports,") {")),n.media&&(r+="@media ".concat(n.media," {"));var s=void 0!==n.layer;s&&(r+="@layer".concat(n.layer.length>0?" ".concat(n.layer):""," {")),r+=n.css,s&&(r+="}"),n.media&&(r+="}"),n.supports&&(r+="}");var i=n.sourceMap;i&&"undefined"!=typeof btoa&&(r+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(i))))," */")),t.styleTagTransform(r,e,t.options)}(t,e,n)},remove:function(){!function(e){if(null===e.parentNode)return!1;e.parentNode.removeChild(e)}(t)}}}},589:e=>{e.exports=function(e,t){if(t.styleSheet)t.styleSheet.cssText=e;else{for(;t.firstChild;)t.removeChild(t.firstChild);t.appendChild(document.createTextNode(e))}}}}]);