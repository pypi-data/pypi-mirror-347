"use strict";(self.webpackChunk_e2xgrader_cell_registry=self.webpackChunk_e2xgrader_cell_registry||[]).push([[357],{357:(e,t,n)=>{n.r(t),n.d(t,{E2XContentFactory:()=>u,E2XMarkdownCell:()=>g,E2X_BUTTON_CLASS:()=>d,E2X_GRADER_SETTINGS_CLASS:()=>s,E2X_METADATA_KEY:()=>c,E2X_UNRENDER_BUTTON_CLASS:()=>a,E2xCellPluginRegistry:()=>E,E2xMetadata:()=>h,IE2xCellPluginRegistry:()=>C,default:()=>x});var l=n(764),i=n(653),r=n(263),o=n(914);const c="extended_cell",s="e2x_grader_options",a="e2x_unrender",d="e2x_btn";var h;!function(e){e.E2X_METADATA_DEFAULTS={type:void 0,options:{}}}(h||(h={}));class g extends o.MarkdownCell{constructor(e){super(e),this.__lastContent="",this._settings=e.settings,this._settings&&this._settings.changed.connect(this.onSettingsUpdated,this),this._registry=e.registry,this._registry&&this._registry.cellPluginRegistered.connect(this.onCellRegistered,this),this.showEditorForReadOnly=!1}get editMode(){return!!this._settings&&this._settings.get("edit_mode").composite}onSettingsUpdated(e){this._graderSection&&(this._graderSection.hidden=!e.get("edit_mode").composite)}onCellRegistered(e,t){const n=t.plugin.cellType,l=t.plugin.renderCell;console.log(`Cell type registered: ${n}, render function: ${l}`),this.e2xCellType===n&&(this.rendered=!1,this._waitForRender(this,2).then((()=>{this.postRender(this)})))}get source(){var e;return(null===(e=this.model)||void 0===e?void 0:e.sharedModel.getSource())||"Type Markdown and LaTeX: $ a^2 $"}get contentChanged(){return this.__lastContent!==this.source}get metadataDefaults(){return h.E2X_METADATA_DEFAULTS}get e2xMetadata(){var e,t;return null!==(t=null===(e=this.model)||void 0===e?void 0:e.getMetadata(c))&&void 0!==t?t:{}}get e2xCellType(){return this.e2xMetadata.type}set e2xCellType(e){var t,n;if(e!==this.e2xCellType){this.setE2xMetadataField("type",e);const l=this.model.toJSON(),i=this.cellIndex;null===(t=this.notebook.model)||void 0===t||t.sharedModel.insertCell(i+1,l),null===(n=this.notebook.model)||void 0===n||n.sharedModel.deleteCell(i)}}getE2xMetadataField(e,t={}){var n,l;return null!==(l=null===(n=this.e2xMetadata)||void 0===n?void 0:n[e])&&void 0!==l?l:t}setE2xMetadataField(e,t){var n;const l=this.e2xMetadata;l[e]=t,null===(n=this.model)||void 0===n||n.setMetadata(c,l)}_waitForRender(e,t){return new Promise((n=>{!function l(){e.node.querySelector(".jp-RenderedMarkdown *")?n(e):setTimeout(l,t)}()}))}renderInput(e){this.readOnly=!0,super.renderInput(e),this.contentChanged&&(this._waitForRender(e,2).then((e=>{this.postRender(e),this.renderGraderSection(e)})),this.__lastContent=this.source)}postRender(e){if(this._registry&&this.e2xCellType){const t=this._registry.getCellPlugin(this.e2xCellType);t&&t.renderCell(e,this)}}renderGraderSection(e){var t;if(!this.e2xCellType)return;if(!(null===(t=this._registry)||void 0===t?void 0:t.getCellPluginTypes().includes(this.e2xCellType)))return;const n=e.node,l=document.createElement("div");l.appendChild(document.createElement("hr")),l.className=s;const i=document.createElement("button");i.classList.add(a,d),i.textContent="Edit Cell",i.onclick=()=>{this.readOnly=!1,this.rendered=!1},l.appendChild(i),this._graderSection=l,this.editMode||(l.hidden=!0),n.appendChild(l)}get notebook(){return this.parent}get cellIndex(){return this.notebook.widgets.findIndex((e=>e===this))}}class u extends r.NotebookPanel.ContentFactory{constructor(e,t,n){super(e),this._settings=t,this._registry=n}createMarkdownCell(e){return e.contentFactory||(e.contentFactory=this),e.settings=this._settings,e.registry=this._registry,new g(e)}}var _=n(602);const C=new(n(262).Token)("@e2xgrader/cell-registry:IE2xCellPluginRegistry");class E{constructor(){this.cellPlugins={},this._cellPluginRegistered=new _.Signal(this)}get cellPluginRegistered(){return this._cellPluginRegistered}registerCellPlugin(e){if(this.cellPlugins[e.cellType])throw new Error(`Cell plugin ${e.cellType} is already registered.`);this.cellPlugins[e.cellType]=e,this._cellPluginRegistered.emit({plugin:e})}getCellPlugin(e){return this.cellPlugins[e]}getCellPlugins(){return Object.values(this.cellPlugins)}getCellPluginLabel(e){var t;return null===(t=this.cellPlugins[e])||void 0===t?void 0:t.label}getCellPluginTypes(){return Object.keys(this.cellPlugins)}}var p,y,m;!function(e){function t(e){var t;return null!==(t=e.getE2xMetadataField("choice"))&&void 0!==t?t:[]}function n(e,t){e.setE2xMetadataField("choice",t)}e.get_choices=t,e.set_choices=n,e.add_choice=function(e,l){const i=t(e);i.includes(l)||(i.push(l),n(e,i))},e.remove_choice=function(e,l){const i=t(e),r=i.indexOf(l);-1!==r&&(i.splice(r,1),n(e,i))},e.get_choice_count=function(e){var t;return null!==(t=e.getE2xMetadataField("num_of_choices"))&&void 0!==t?t:0},e.set_choice_count=function(e,t){e.setE2xMetadataField("num_of_choices",t)},e.get_choice=function(e){var t;return null!==(t=e.getE2xMetadataField("choice"))&&void 0!==t?t:""},e.set_choice=function(e,t){e.setE2xMetadataField("choice",t)}}(p||(p={})),function(e){function t(e,t,n){const l=document.createElement("input");return l.type="checkbox",l.name=e.model.id,l.value=t,l.checked=n,l.onchange=n=>{n.target.checked?p.add_choice(e,t):p.remove_choice(e,t)},l}function n(n,l){console.log("Rendering MC cell:",l);const i=n.node.querySelectorAll("ul");if(0===i.length)return;const r=i[0],o=r.querySelectorAll("li"),c=document.createElement("form");c.classList.add(e.E2X_MULTIPLECHOICE_FORM_CLASS),p.get_choice_count(l)!==o.length&&(p.set_choice_count(l,o.length),p.set_choices(l,[]));const s=p.get_choices(l);o.forEach(((e,n)=>{const i=t(l,n.toString(),s.includes(n.toString())),r=document.createElement("label");r.innerHTML=e.innerHTML,c.appendChild(i),c.appendChild(r),c.appendChild(document.createElement("br"))})),r.replaceWith(c)}e.E2X_MULTIPLECHOICE_CELL_TYPE="multiplechoice",e.E2X_MULTIPLECHOICE_FORM_CLASS="e2x-multiplechoice-form",e.cleanMetadata={choice:[],num_of_choices:0,type:e.E2X_MULTIPLECHOICE_CELL_TYPE},e.createChoiceElement=t,e.renderCell=n,e.cellPlugin={cellType:e.E2X_MULTIPLECHOICE_CELL_TYPE,label:"Multiple Choice",renderCell:n,cleanMetadata:e.cleanMetadata}}(y||(y={})),function(e){function t(e,t,n){const l=document.createElement("input");return l.type="radio",l.name=e.model.id,l.value=t,l.checked=n,l.onchange=n=>{n.target.checked&&p.set_choice(e,t)},l}function n(n,l){console.log("Rendering SC cell:",l);const i=n.node.querySelectorAll("ul");if(0===i.length)return;const r=i[0],o=r.querySelectorAll("li"),c=document.createElement("form");c.classList.add(e.E2X_SINGLECHOICE_FORM_CLASS);const s=p.get_choice(l);""!==s&&parseInt(s)>=o.length&&p.set_choice(l,""),o.forEach(((e,n)=>{const i=t(l,n.toString(),s===n.toString()),r=document.createElement("label");r.innerHTML=e.innerHTML,c.appendChild(i),c.appendChild(r),c.appendChild(document.createElement("br"))})),r.replaceWith(c)}e.E2X_SINGLECHOICE_CELL_TYPE="singlechoice",e.E2X_SINGLECHOICE_FORM_CLASS="e2x-singlechoice-form",e.cleanMetadata={choice:"",type:e.E2X_SINGLECHOICE_CELL_TYPE},e.createChoiceElement=t,e.renderCell=n,e.cellPlugin={cellType:e.E2X_SINGLECHOICE_CELL_TYPE,label:"Single Choice",renderCell:n,cleanMetadata:e.cleanMetadata}}(m||(m={}));const M=[y.cellPlugin,m.cellPlugin],v={id:"@e2xgrader/cell-registry:cell-registry",provides:C,autoStart:!0,activate:e=>{console.log("JupyterLab extension @e2xgrader/cell-registry:cell-registry is activated!");const t=new E;return e.serviceManager.ready.then((()=>{console.log("Cell registry is ready.")})),console.log("Cell registry created:",t),M.forEach((e=>{t.registerCellPlugin(e)})),t}},T={id:"@e2xgrader/cell-registry:cell-factory",requires:[l.IEditorServices,C],optional:[i.ISettingRegistry],provides:r.NotebookPanel.IContentFactory,activate:async(e,t,n,l)=>{console.log("JupyterLab extension @e2xgrader/cell-registry:cell-factory is activated!");const i=t.factoryService.newInlineEditor;let r;if(l){const e=await l.load(T.id);r=new u({editorFactory:i},e,n)}else r=new u({editorFactory:i},void 0,n);return console.log("E2XContentFactory created:",r),r}},x=[v,T]}}]);