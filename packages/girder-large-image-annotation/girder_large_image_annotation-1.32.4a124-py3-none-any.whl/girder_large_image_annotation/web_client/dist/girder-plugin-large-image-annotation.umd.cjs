(function(ae){typeof define=="function"&&define.amd?define(ae):ae()})(function(){"use strict";function ae(a,e,n,t){if(e===!1||e==null||!e&&a==="style")return"";if(e===!0)return" "+(a+'="'+a+'"');var i=typeof e;return i!=="object"&&i!=="function"||typeof e.toJSON!="function"||(e=e.toJSON()),typeof e=="string"||(e=JSON.stringify(e),n)?(e=tt(e)," "+a+'="'+e+'"'):" "+a+"='"+e.replace(/'/g,"&#39;")+"'"}function tt(a){var e=""+a,n=nt.exec(e);if(!n)return a;var t,i,o,c="";for(t=n.index,i=0;t<e.length;t++){switch(e.charCodeAt(t)){case 34:o="&quot;";break;case 38:o="&amp;";break;case 60:o="&lt;";break;case 62:o="&gt;";break;default:continue}i!==t&&(c+=e.substring(i,t)),i=t+1,c+=o}return i!==t?c+e.substring(i,t):c}var nt=/["&<>]/;function Oe(a,e,n,t){if(!(a instanceof Error))throw a;if(!(typeof window>"u"&&e||t))throw a.message+=" on line "+n,a;var i,o,c,g;try{t=t||require("fs").readFileSync(e,{encoding:"utf8"}),i=3,o=t.split(`
`),c=Math.max(n-i,0),g=Math.min(o.length,n+i)}catch(d){return a.message+=" - could not read from "+e+" ("+d.message+")",void Oe(a,null,n)}i=o.slice(c,g).map(function(d,u){var h=u+c+1;return(h==n?"  > ":"    ")+h+"| "+d}).join(`
`),a.path=e;try{a.message=(e||"Pug")+":"+n+`
`+i+`

`+a.message}catch{}throw a}function it(a){var e="",n,t;try{var i=a||{};(function(o){t=1,n="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/largeImageAnnotationConfig.pug",e=e+'<div class="g-config-breadcrumb-container"></div>',t=2,n="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/largeImageAnnotationConfig.pug",e=e+'<form id="g-large-image-form" role="form">',t=3,n="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/largeImageAnnotationConfig.pug",e=e+'<div class="form-group">',t=4,n="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/largeImageAnnotationConfig.pug",e=e+"<label>",t=4,n="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/largeImageAnnotationConfig.pug",e=e+"Store annotation history</label>",t=5,n="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/largeImageAnnotationConfig.pug",e=e+'<p class="g-large-image-description">',t=6,n="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/largeImageAnnotationConfig.pug",e=e+"Whenever annotations are saved, a record of the annotation's previous state can be kept.</p>",t=7,n="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/largeImageAnnotationConfig.pug",e=e+'<div class="g-large-image-annotation-history-container">',t=8,n="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/largeImageAnnotationConfig.pug",e=e+'<label class="radio-inline">',t=9,n="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/largeImageAnnotationConfig.pug",e=e+"<input"+(' class="g-large-image-annotation-history-show" type="radio" name="g-large-image-annotation-history"'+ae("checked",o["large_image.annotation_history"]!==!1?"checked":void 0,!0,!1))+"/>",t=10,n="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/largeImageAnnotationConfig.pug",e=e+"Record annotation history</label>",t=11,n="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/largeImageAnnotationConfig.pug",e=e+'<label class="radio-inline">',t=12,n="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/largeImageAnnotationConfig.pug",e=e+"<input"+(' class="g-large-image-annotation-history-hide" type="radio" name="g-large-image-annotation-history"'+ae("checked",o["large_image.annotation_history"]!==!1?void 0:"checked",!0,!1))+"/>",t=13,n="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/largeImageAnnotationConfig.pug",e=e+"Don't store history</label></div></div>",t=14,n="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/largeImageAnnotationConfig.pug",e=e+'<p class="g-validation-failed-message" id="g-large-image-error-message"></p>',t=15,n="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/largeImageAnnotationConfig.pug",e=e+'<input class="btn btn-sm btn-primary" type="submit" value="Save"/></form>'}).call(this,"settings"in i?i.settings:typeof settings<"u"?settings:void 0)}catch(o){Oe(o,n,t)}return e}const at=girder.views.View,rt=girder.views.widgets.PluginConfigBreadcrumbWidget,{restRequest:ot}=girder.rest,st=girder.events;var K=at.extend({events:{"submit #g-large-image-form":function(a){a.preventDefault(),this.$("#g-large-image-error-message").empty(),this._saveSettings([{key:"large_image.annotation_history",value:this.$(".g-large-image-annotation-history-show").prop("checked")}])}},initialize:function(){K.getSettings(a=>{this.settings=a,this.render()})},render:function(){return this.$el.html(it({settings:this.settings,viewers:K.viewers})),this.breadcrumb||(this.breadcrumb=new rt({pluginName:"Large image annotation",el:this.$(".g-config-breadcrumb-container"),parentView:this}).render()),this},_saveSettings:function(a){return ot({type:"PUT",url:"system/setting",data:{list:JSON.stringify(a)},error:null}).done(()=>{K.clearSettings(),st.trigger("g:alert",{icon:"ok",text:"Settings saved.",type:"success",timeout:4e3})}).fail(e=>{this.$("#g-large-image-error-message").text(e.responseJSON.message)})}},{getSettings:function(a){return girder.plugins.large_image.views.ConfigView.getSettings(a)},clearSettings:function(){return girder.plugins.large_image.views.ConfigView.clearSettings()}});const ut=girder.events,lt=girder.router,{exposePluginConfig:gt}=girder.utilities.PluginUtils;gt("large_image_annotation","plugins/large_image_annotation/config"),lt.route("plugins/large_image_annotation/config","largeImageAnnotationConfig",function(){ut.trigger("g:navigateTo",K)});function Se(a,e,n,t){if(!(a instanceof Error))throw a;if(!(typeof window>"u"&&e||t))throw a.message+=" on line "+n,a;var i,o,c,g;try{t=t||require("fs").readFileSync(e,{encoding:"utf8"}),i=3,o=t.split(`
`),c=Math.max(n-i,0),g=Math.min(o.length,n+i)}catch(d){return a.message+=" - could not read from "+e+" ("+d.message+")",void Se(a,null,n)}i=o.slice(c,g).map(function(d,u){var h=u+c+1;return(h==n?"  > ":"    ")+h+"| "+d}).join(`
`),a.path=e;try{a.message=(e||"Pug")+":"+n+`
`+i+`

`+a.message}catch{}throw a}function ct(a){var e="",n,t;try{t=1,n="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/imageViewerAnnotationList.pug",e=e+'<div class="g-annotation-list-container"></div>'}catch(i){Se(i,n,t)}return e}const dt=girder.Backbone.Model.extend({idAttribute:"id"}),ke=girder.Backbone.Collection.extend({model:dt,comparator:void 0});function me(a,e){const n=Math.cos(a),t=Math.sin(a);return e=e||[0,0],function(i){const o=i[0]-e[0],c=i[1]-e[1];return[o*n-c*t+e[0],o*t+c*n+e[1]]}}const ht=girder._;function _t(a){const e=a.center,n=e[0],t=e[1],i=a.height,o=a.width,c=a.rotation||0,g=n-o/2,d=n+o/2,u=t-i/2,h=t+i/2;return{type:"Polygon",coordinates:[ht.map([[g,u],[d,u],[d,h],[g,h],[g,u]],me(c,e))],annotationType:"rectangle"}}const Ft=girder._;function pt(a){const e=a.center,n=e[0],t=e[1],i=a.height,o=a.width,c=a.rotation||0,g=n-o/2,d=n+o/2,u=t-i/2,h=t+i/2;return{type:"Polygon",coordinates:[Ft.map([[g,u],[d,u],[d,h],[g,h],[g,u]],me(c,e))],annotationType:"ellipse"}}function ft(a){const e=a.center,n=e[0],t=e[1],i=a.radius,o=n-i,c=n+i,g=t-i,d=t+i;return{type:"Polygon",coordinates:[[[o,g],[c,g],[c,d],[o,d],[o,g]]],annotationType:"circle"}}const ye=girder._;function mt(a){const e=ye.map(a.points,o=>ye.first(o,2));var n,t,i;if(a.closed){if(e.push(e[0]),t=[e],a.holes){const o=(a.holes||[]).map(c=>{const g=c.map(d=>ye.first(d,2));return g.push(g[0]),g});t=t.concat(o)}n="Polygon",i="polygon"}else n="LineString",t=e,i="line";return{type:n,coordinates:t,annotationType:i}}const yt=girder._;function bt(a){return{type:"Point",coordinates:yt.first(a.center,2),annotationType:"point"}}const be=Object.freeze(Object.defineProperty({__proto__:null,circle:ft,ellipse:pt,point:bt,polyline:mt,rectangle:_t},Symbol.toStringTag,{value:"Module"})),we=Object.freeze(Object.defineProperty({__proto__:null,circle:{fillColor:"rgba(0,0,0,0)",lineColor:"rgb(0,0,0)",lineWidth:2},ellipse:{fillColor:"rgba(0,0,0,0)",lineColor:"rgb(0,0,0)",lineWidth:2,rotation:0,normal:[0,0,1]},point:{lineColor:"rgb(0,0,0)",lineWidth:2,fillColor:"rgba(0,0,0,0)"},polyline:{fillColor:"rgba(0,0,0,0)",lineColor:"rgb(0,0,0)",lineWidth:2},rectangle:{fillColor:"rgba(0,0,0,0)",lineColor:"rgb(0,0,0)",lineWidth:2,rotation:0,normal:[0,0,1]}},Symbol.toStringTag,{value:"Module"}));function wt(a){return a&&a.__esModule&&Object.prototype.hasOwnProperty.call(a,"default")?a.default:a}var Te={exports:{}};(function(a){(function(e){var n=/^\s+/,t=/\s+$/,i=0,o=e.round,c=e.min,g=e.max,d=e.random;function u(r,l){if(r=r||"",l=l||{},r instanceof u)return r;if(!(this instanceof u))return new u(r,l);var s=h(r);this._originalInput=r,this._r=s.r,this._g=s.g,this._b=s.b,this._a=s.a,this._roundA=o(100*this._a)/100,this._format=l.format||s.format,this._gradientType=l.gradientType,this._r<1&&(this._r=o(this._r)),this._g<1&&(this._g=o(this._g)),this._b<1&&(this._b=o(this._b)),this._ok=s.ok,this._tc_id=i++}u.prototype={isDark:function(){return this.getBrightness()<128},isLight:function(){return!this.isDark()},isValid:function(){return this._ok},getOriginalInput:function(){return this._originalInput},getFormat:function(){return this._format},getAlpha:function(){return this._a},getBrightness:function(){var r=this.toRgb();return(r.r*299+r.g*587+r.b*114)/1e3},getLuminance:function(){var r=this.toRgb(),l,s,_,f,p,j;return l=r.r/255,s=r.g/255,_=r.b/255,l<=.03928?f=l/12.92:f=e.pow((l+.055)/1.055,2.4),s<=.03928?p=s/12.92:p=e.pow((s+.055)/1.055,2.4),_<=.03928?j=_/12.92:j=e.pow((_+.055)/1.055,2.4),.2126*f+.7152*p+.0722*j},setAlpha:function(r){return this._a=q(r),this._roundA=o(100*this._a)/100,this},toHsv:function(){var r=v(this._r,this._g,this._b);return{h:r.h*360,s:r.s,v:r.v,a:this._a}},toHsvString:function(){var r=v(this._r,this._g,this._b),l=o(r.h*360),s=o(r.s*100),_=o(r.v*100);return this._a==1?"hsv("+l+", "+s+"%, "+_+"%)":"hsva("+l+", "+s+"%, "+_+"%, "+this._roundA+")"},toHsl:function(){var r=y(this._r,this._g,this._b);return{h:r.h*360,s:r.s,l:r.l,a:this._a}},toHslString:function(){var r=y(this._r,this._g,this._b),l=o(r.h*360),s=o(r.s*100),_=o(r.l*100);return this._a==1?"hsl("+l+", "+s+"%, "+_+"%)":"hsla("+l+", "+s+"%, "+_+"%, "+this._roundA+")"},toHex:function(r){return I(this._r,this._g,this._b,r)},toHexString:function(r){return"#"+this.toHex(r)},toHex8:function(r){return M(this._r,this._g,this._b,this._a,r)},toHex8String:function(r){return"#"+this.toHex8(r)},toRgb:function(){return{r:o(this._r),g:o(this._g),b:o(this._b),a:this._a}},toRgbString:function(){return this._a==1?"rgb("+o(this._r)+", "+o(this._g)+", "+o(this._b)+")":"rgba("+o(this._r)+", "+o(this._g)+", "+o(this._b)+", "+this._roundA+")"},toPercentageRgb:function(){return{r:o(A(this._r,255)*100)+"%",g:o(A(this._g,255)*100)+"%",b:o(A(this._b,255)*100)+"%",a:this._a}},toPercentageRgbString:function(){return this._a==1?"rgb("+o(A(this._r,255)*100)+"%, "+o(A(this._g,255)*100)+"%, "+o(A(this._b,255)*100)+"%)":"rgba("+o(A(this._r,255)*100)+"%, "+o(A(this._g,255)*100)+"%, "+o(A(this._b,255)*100)+"%, "+this._roundA+")"},toName:function(){return this._a===0?"transparent":this._a<1?!1:An[I(this._r,this._g,this._b,!0)]||!1},toFilter:function(r){var l="#"+W(this._r,this._g,this._b,this._a),s=l,_=this._gradientType?"GradientType = 1, ":"";if(r){var f=u(r);s="#"+W(f._r,f._g,f._b,f._a)}return"progid:DXImageTransform.Microsoft.gradient("+_+"startColorstr="+l+",endColorstr="+s+")"},toString:function(r){var l=!!r;r=r||this._format;var s=!1,_=this._a<1&&this._a>=0,f=!l&&_&&(r==="hex"||r==="hex6"||r==="hex3"||r==="hex4"||r==="hex8"||r==="name");return f?r==="name"&&this._a===0?this.toName():this.toRgbString():(r==="rgb"&&(s=this.toRgbString()),r==="prgb"&&(s=this.toPercentageRgbString()),(r==="hex"||r==="hex6")&&(s=this.toHexString()),r==="hex3"&&(s=this.toHexString(!0)),r==="hex4"&&(s=this.toHex8String(!0)),r==="hex8"&&(s=this.toHex8String()),r==="name"&&(s=this.toName()),r==="hsl"&&(s=this.toHslString()),r==="hsv"&&(s=this.toHsvString()),s||this.toHexString())},clone:function(){return u(this.toString())},_applyModification:function(r,l){var s=r.apply(null,[this].concat([].slice.call(l)));return this._r=s._r,this._g=s._g,this._b=s._b,this.setAlpha(s._a),this},lighten:function(){return this._applyModification(se,arguments)},brighten:function(){return this._applyModification(Z,arguments)},darken:function(){return this._applyModification(z,arguments)},desaturate:function(){return this._applyModification(R,arguments)},saturate:function(){return this._applyModification(D,arguments)},greyscale:function(){return this._applyModification(m,arguments)},spin:function(){return this._applyModification(Q,arguments)},_applyCombination:function(r,l){return r.apply(null,[this].concat([].slice.call(l)))},analogous:function(){return this._applyCombination(C,arguments)},complement:function(){return this._applyCombination(J,arguments)},monochromatic:function(){return this._applyCombination(E,arguments)},splitcomplement:function(){return this._applyCombination(ue,arguments)},triad:function(){return this._applyCombination(Y,arguments)},tetrad:function(){return this._applyCombination(X,arguments)}},u.fromRatio=function(r,l){if(typeof r=="object"){var s={};for(var _ in r)r.hasOwnProperty(_)&&(_==="a"?s[_]=r[_]:s[_]=ge(r[_]));r=s}return u(r,l)};function h(r){var l={r:0,g:0,b:0},s=1,_=null,f=null,p=null,j=!1,S=!1;return typeof r=="string"&&(r=xn(r)),typeof r=="object"&&(N(r.r)&&N(r.g)&&N(r.b)?(l=F(r.r,r.g,r.b),j=!0,S=String(r.r).substr(-1)==="%"?"prgb":"rgb"):N(r.h)&&N(r.s)&&N(r.v)?(_=ge(r.s),f=ge(r.v),l=L(r.h,_,f),j=!0,S="hsv"):N(r.h)&&N(r.s)&&N(r.l)&&(_=ge(r.s),p=ge(r.l),l=b(r.h,_,p),j=!0,S="hsl"),r.hasOwnProperty("a")&&(s=r.a)),s=q(s),{ok:j,format:r.format||S,r:c(255,g(l.r,0)),g:c(255,g(l.g,0)),b:c(255,g(l.b,0)),a:s}}function F(r,l,s){return{r:A(r,255)*255,g:A(l,255)*255,b:A(s,255)*255}}function y(r,l,s){r=A(r,255),l=A(l,255),s=A(s,255);var _=g(r,l,s),f=c(r,l,s),p,j,S=(_+f)/2;if(_==f)p=j=0;else{var k=_-f;switch(j=S>.5?k/(2-_-f):k/(_+f),_){case r:p=(l-s)/k+(l<s?6:0);break;case l:p=(s-r)/k+2;break;case s:p=(r-l)/k+4;break}p/=6}return{h:p,s:j,l:S}}function b(r,l,s){var _,f,p;r=A(r,360),l=A(l,100),s=A(s,100);function j(P,ce,V){return V<0&&(V+=1),V>1&&(V-=1),V<1/6?P+(ce-P)*6*V:V<1/2?ce:V<2/3?P+(ce-P)*(2/3-V)*6:P}if(l===0)_=f=p=s;else{var S=s<.5?s*(1+l):s+l-s*l,k=2*s-S;_=j(k,S,r+1/3),f=j(k,S,r),p=j(k,S,r-1/3)}return{r:_*255,g:f*255,b:p*255}}function v(r,l,s){r=A(r,255),l=A(l,255),s=A(s,255);var _=g(r,l,s),f=c(r,l,s),p,j,S=_,k=_-f;if(j=_===0?0:k/_,_==f)p=0;else{switch(_){case r:p=(l-s)/k+(l<s?6:0);break;case l:p=(s-r)/k+2;break;case s:p=(r-l)/k+4;break}p/=6}return{h:p,s:j,v:S}}function L(r,l,s){r=A(r,360)*6,l=A(l,100),s=A(s,100);var _=e.floor(r),f=r-_,p=s*(1-l),j=s*(1-f*l),S=s*(1-(1-f)*l),k=_%6,P=[s,j,p,p,S,s][k],ce=[S,s,s,j,p,p][k],V=[p,p,S,s,s,j][k];return{r:P*255,g:ce*255,b:V*255}}function I(r,l,s,_){var f=[H(o(r).toString(16)),H(o(l).toString(16)),H(o(s).toString(16))];return _&&f[0].charAt(0)==f[0].charAt(1)&&f[1].charAt(0)==f[1].charAt(1)&&f[2].charAt(0)==f[2].charAt(1)?f[0].charAt(0)+f[1].charAt(0)+f[2].charAt(0):f.join("")}function M(r,l,s,_,f){var p=[H(o(r).toString(16)),H(o(l).toString(16)),H(o(s).toString(16)),H(et(_))];return f&&p[0].charAt(0)==p[0].charAt(1)&&p[1].charAt(0)==p[1].charAt(1)&&p[2].charAt(0)==p[2].charAt(1)&&p[3].charAt(0)==p[3].charAt(1)?p[0].charAt(0)+p[1].charAt(0)+p[2].charAt(0)+p[3].charAt(0):p.join("")}function W(r,l,s,_){var f=[H(et(_)),H(o(r).toString(16)),H(o(l).toString(16)),H(o(s).toString(16))];return f.join("")}u.equals=function(r,l){return!r||!l?!1:u(r).toRgbString()==u(l).toRgbString()},u.random=function(){return u.fromRatio({r:d(),g:d(),b:d()})};function R(r,l){l=l===0?0:l||10;var s=u(r).toHsl();return s.s-=l/100,s.s=G(s.s),u(s)}function D(r,l){l=l===0?0:l||10;var s=u(r).toHsl();return s.s+=l/100,s.s=G(s.s),u(s)}function m(r){return u(r).desaturate(100)}function se(r,l){l=l===0?0:l||10;var s=u(r).toHsl();return s.l+=l/100,s.l=G(s.l),u(s)}function Z(r,l){l=l===0?0:l||10;var s=u(r).toRgb();return s.r=g(0,c(255,s.r-o(255*-(l/100)))),s.g=g(0,c(255,s.g-o(255*-(l/100)))),s.b=g(0,c(255,s.b-o(255*-(l/100)))),u(s)}function z(r,l){l=l===0?0:l||10;var s=u(r).toHsl();return s.l-=l/100,s.l=G(s.l),u(s)}function Q(r,l){var s=u(r).toHsl(),_=(s.h+l)%360;return s.h=_<0?360+_:_,u(s)}function J(r){var l=u(r).toHsl();return l.h=(l.h+180)%360,u(l)}function Y(r){var l=u(r).toHsl(),s=l.h;return[u(r),u({h:(s+120)%360,s:l.s,l:l.l}),u({h:(s+240)%360,s:l.s,l:l.l})]}function X(r){var l=u(r).toHsl(),s=l.h;return[u(r),u({h:(s+90)%360,s:l.s,l:l.l}),u({h:(s+180)%360,s:l.s,l:l.l}),u({h:(s+270)%360,s:l.s,l:l.l})]}function ue(r){var l=u(r).toHsl(),s=l.h;return[u(r),u({h:(s+72)%360,s:l.s,l:l.l}),u({h:(s+216)%360,s:l.s,l:l.l})]}function C(r,l,s){l=l||6,s=s||30;var _=u(r).toHsl(),f=360/s,p=[u(r)];for(_.h=(_.h-(f*l>>1)+720)%360;--l;)_.h=(_.h+f)%360,p.push(u(_));return p}function E(r,l){l=l||6;for(var s=u(r).toHsv(),_=s.h,f=s.s,p=s.v,j=[],S=1/l;l--;)j.push(u({h:_,s:f,v:p})),p=(p+S)%1;return j}u.mix=function(r,l,s){s=s===0?0:s||50;var _=u(r).toRgb(),f=u(l).toRgb(),p=s/100,j={r:(f.r-_.r)*p+_.r,g:(f.g-_.g)*p+_.g,b:(f.b-_.b)*p+_.b,a:(f.a-_.a)*p+_.a};return u(j)},u.readability=function(r,l){var s=u(r),_=u(l);return(e.max(s.getLuminance(),_.getLuminance())+.05)/(e.min(s.getLuminance(),_.getLuminance())+.05)},u.isReadable=function(r,l,s){var _=u.readability(r,l),f,p;switch(p=!1,f=jn(s),f.level+f.size){case"AAsmall":case"AAAlarge":p=_>=4.5;break;case"AAlarge":p=_>=3;break;case"AAAsmall":p=_>=7;break}return p},u.mostReadable=function(r,l,s){var _=null,f=0,p,j,S,k;s=s||{},j=s.includeFallbackColors,S=s.level,k=s.size;for(var P=0;P<l.length;P++)p=u.readability(r,l[P]),p>f&&(f=p,_=u(l[P]));return u.isReadable(r,_,{level:S,size:k})||!j?_:(s.includeFallbackColors=!1,u.mostReadable(r,["#fff","#000"],s))};var le=u.names={aliceblue:"f0f8ff",antiquewhite:"faebd7",aqua:"0ff",aquamarine:"7fffd4",azure:"f0ffff",beige:"f5f5dc",bisque:"ffe4c4",black:"000",blanchedalmond:"ffebcd",blue:"00f",blueviolet:"8a2be2",brown:"a52a2a",burlywood:"deb887",burntsienna:"ea7e5d",cadetblue:"5f9ea0",chartreuse:"7fff00",chocolate:"d2691e",coral:"ff7f50",cornflowerblue:"6495ed",cornsilk:"fff8dc",crimson:"dc143c",cyan:"0ff",darkblue:"00008b",darkcyan:"008b8b",darkgoldenrod:"b8860b",darkgray:"a9a9a9",darkgreen:"006400",darkgrey:"a9a9a9",darkkhaki:"bdb76b",darkmagenta:"8b008b",darkolivegreen:"556b2f",darkorange:"ff8c00",darkorchid:"9932cc",darkred:"8b0000",darksalmon:"e9967a",darkseagreen:"8fbc8f",darkslateblue:"483d8b",darkslategray:"2f4f4f",darkslategrey:"2f4f4f",darkturquoise:"00ced1",darkviolet:"9400d3",deeppink:"ff1493",deepskyblue:"00bfff",dimgray:"696969",dimgrey:"696969",dodgerblue:"1e90ff",firebrick:"b22222",floralwhite:"fffaf0",forestgreen:"228b22",fuchsia:"f0f",gainsboro:"dcdcdc",ghostwhite:"f8f8ff",gold:"ffd700",goldenrod:"daa520",gray:"808080",green:"008000",greenyellow:"adff2f",grey:"808080",honeydew:"f0fff0",hotpink:"ff69b4",indianred:"cd5c5c",indigo:"4b0082",ivory:"fffff0",khaki:"f0e68c",lavender:"e6e6fa",lavenderblush:"fff0f5",lawngreen:"7cfc00",lemonchiffon:"fffacd",lightblue:"add8e6",lightcoral:"f08080",lightcyan:"e0ffff",lightgoldenrodyellow:"fafad2",lightgray:"d3d3d3",lightgreen:"90ee90",lightgrey:"d3d3d3",lightpink:"ffb6c1",lightsalmon:"ffa07a",lightseagreen:"20b2aa",lightskyblue:"87cefa",lightslategray:"789",lightslategrey:"789",lightsteelblue:"b0c4de",lightyellow:"ffffe0",lime:"0f0",limegreen:"32cd32",linen:"faf0e6",magenta:"f0f",maroon:"800000",mediumaquamarine:"66cdaa",mediumblue:"0000cd",mediumorchid:"ba55d3",mediumpurple:"9370db",mediumseagreen:"3cb371",mediumslateblue:"7b68ee",mediumspringgreen:"00fa9a",mediumturquoise:"48d1cc",mediumvioletred:"c71585",midnightblue:"191970",mintcream:"f5fffa",mistyrose:"ffe4e1",moccasin:"ffe4b5",navajowhite:"ffdead",navy:"000080",oldlace:"fdf5e6",olive:"808000",olivedrab:"6b8e23",orange:"ffa500",orangered:"ff4500",orchid:"da70d6",palegoldenrod:"eee8aa",palegreen:"98fb98",paleturquoise:"afeeee",palevioletred:"db7093",papayawhip:"ffefd5",peachpuff:"ffdab9",peru:"cd853f",pink:"ffc0cb",plum:"dda0dd",powderblue:"b0e0e6",purple:"800080",rebeccapurple:"663399",red:"f00",rosybrown:"bc8f8f",royalblue:"4169e1",saddlebrown:"8b4513",salmon:"fa8072",sandybrown:"f4a460",seagreen:"2e8b57",seashell:"fff5ee",sienna:"a0522d",silver:"c0c0c0",skyblue:"87ceeb",slateblue:"6a5acd",slategray:"708090",slategrey:"708090",snow:"fffafa",springgreen:"00ff7f",steelblue:"4682b4",tan:"d2b48c",teal:"008080",thistle:"d8bfd8",tomato:"ff6347",turquoise:"40e0d0",violet:"ee82ee",wheat:"f5deb3",white:"fff",whitesmoke:"f5f5f5",yellow:"ff0",yellowgreen:"9acd32"},An=u.hexNames=En(le);function En(r){var l={};for(var s in r)r.hasOwnProperty(s)&&(l[r[s]]=s);return l}function q(r){return r=parseFloat(r),(isNaN(r)||r<0||r>1)&&(r=1),r}function A(r,l){x(r)&&(r="100%");var s=$e(r);return r=c(l,g(0,parseFloat(r))),s&&(r=parseInt(r*l,10)/100),e.abs(r-l)<1e-6?1:r%l/parseFloat(l)}function G(r){return c(1,g(0,r))}function w(r){return parseInt(r,16)}function x(r){return typeof r=="string"&&r.indexOf(".")!=-1&&parseFloat(r)===1}function $e(r){return typeof r=="string"&&r.indexOf("%")!=-1}function H(r){return r.length==1?"0"+r:""+r}function ge(r){return r<=1&&(r=r*100+"%"),r}function et(r){return e.round(parseFloat(r)*255).toString(16)}function fe(r){return w(r)/255}var U=function(){var r="[-\\+]?\\d+%?",l="[-\\+]?\\d*\\.\\d+%?",s="(?:"+l+")|(?:"+r+")",_="[\\s|\\(]+("+s+")[,|\\s]+("+s+")[,|\\s]+("+s+")\\s*\\)?",f="[\\s|\\(]+("+s+")[,|\\s]+("+s+")[,|\\s]+("+s+")[,|\\s]+("+s+")\\s*\\)?";return{CSS_UNIT:new RegExp(s),rgb:new RegExp("rgb"+_),rgba:new RegExp("rgba"+f),hsl:new RegExp("hsl"+_),hsla:new RegExp("hsla"+f),hsv:new RegExp("hsv"+_),hsva:new RegExp("hsva"+f),hex3:/^#?([0-9a-fA-F]{1})([0-9a-fA-F]{1})([0-9a-fA-F]{1})$/,hex6:/^#?([0-9a-fA-F]{2})([0-9a-fA-F]{2})([0-9a-fA-F]{2})$/,hex4:/^#?([0-9a-fA-F]{1})([0-9a-fA-F]{1})([0-9a-fA-F]{1})([0-9a-fA-F]{1})$/,hex8:/^#?([0-9a-fA-F]{2})([0-9a-fA-F]{2})([0-9a-fA-F]{2})([0-9a-fA-F]{2})$/}}();function N(r){return!!U.CSS_UNIT.exec(r)}function xn(r){r=r.replace(n,"").replace(t,"").toLowerCase();var l=!1;if(le[r])r=le[r],l=!0;else if(r=="transparent")return{r:0,g:0,b:0,a:0,format:"name"};var s;return(s=U.rgb.exec(r))?{r:s[1],g:s[2],b:s[3]}:(s=U.rgba.exec(r))?{r:s[1],g:s[2],b:s[3],a:s[4]}:(s=U.hsl.exec(r))?{h:s[1],s:s[2],l:s[3]}:(s=U.hsla.exec(r))?{h:s[1],s:s[2],l:s[3],a:s[4]}:(s=U.hsv.exec(r))?{h:s[1],s:s[2],v:s[3]}:(s=U.hsva.exec(r))?{h:s[1],s:s[2],v:s[3],a:s[4]}:(s=U.hex8.exec(r))?{r:w(s[1]),g:w(s[2]),b:w(s[3]),a:fe(s[4]),format:l?"name":"hex8"}:(s=U.hex6.exec(r))?{r:w(s[1]),g:w(s[2]),b:w(s[3]),format:l?"name":"hex"}:(s=U.hex4.exec(r))?{r:w(s[1]+""+s[1]),g:w(s[2]+""+s[2]),b:w(s[3]+""+s[3]),a:fe(s[4]+""+s[4]),format:l?"name":"hex8"}:(s=U.hex3.exec(r))?{r:w(s[1]+""+s[1]),g:w(s[2]+""+s[2]),b:w(s[3]+""+s[3]),format:l?"name":"hex"}:!1}function jn(r){var l,s;return r=r||{level:"AA",size:"small"},l=(r.level||"AA").toUpperCase(),s=(r.size||"small").toLowerCase(),l!=="AA"&&l!=="AAA"&&(l="AA"),s!=="small"&&s!=="large"&&(s="small"),{level:l,size:s}}a.exports?a.exports=u:window.tinycolor=u})(Math)})(Te);var vt=Te.exports;const Ct=wt(vt);var ee={entries:0};function Ie(a){if(ee[a])return ee[a];var e=Ct(a),n={rgb:e.toHexString(),alpha:e.getAlpha()};return ee.entries+=1,ee.entries>100&&(ee={entries:0}),ee[a]=n,n}function ve(a){var e;const n={};return a.label&&(n.label=a.label),a.fillColor&&(e=Ie(a.fillColor),n.fillColor=e.rgb,n.fillOpacity=e.alpha),a.lineColor&&(e=Ie(a.lineColor),n.strokeColor=e.rgb,n.strokeOpacity=e.alpha),a.lineWidth&&(n.strokeWidth=a.lineWidth),n}const de=girder._;function Lt(a){return function(e,n){if((""+n).startsWith("_"))return;const t=e.type;if(e=de.defaults({},e,we[t]||{}),!de.has(be,t))return;const i=be[t](e);return{type:"Feature",id:e.id,geometry:{type:i.type,coordinates:i.coordinates},properties:de.extend({element:e,annotationType:i.annotationType},a,ve(e))}}}function Re(a,e={}){return{type:"FeatureCollection",features:de.chain(a).mapObject(Lt(e)).compact().value()}}function Ce(a,e){let n=0,t=1,i=0,o=null;const c={0:{r:0,g:0,b:0,a:0},1:{r:1,g:1,b:0,a:1}};if(a.colorRange&&a.rangeValues){if(a.normalizeRange||!e.length)for(let g=0;g<a.colorRange.length&&g<a.rangeValues.length;g+=1){const d=Math.max(0,Math.min(1,a.rangeValues[g]));if(c[d]=a.colorRange[g],d>=1)break}else if(a.colorRange.length>=2&&a.rangeValues.length>=2){n=t=a.rangeValues[0]||0;for(let g=1;g<a.rangeValues.length;g+=1){const d=a.rangeValues[g]||0;d<n&&(n=d),d>t&&(t=d)}n===t&&(n-=1),i=void 0;for(let g=0;g<a.colorRange.length&&g<a.rangeValues.length;g+=1){let d=(a.rangeValues[g]-n)/(t-n||1);if((d<=0||i===void 0)&&(i=a.rangeValues[g]),o=a.rangeValues[g],d=Math.max(0,Math.min(1,d)),c[d]=a.colorRange[g],d>=1)break}}}return{color:c,min:i,max:o}}function At(a,e,n){const t=n.map(),i=t.layers().find(u=>u instanceof window.geo.tileLayer&&u.options&&u.options.maxLevel!==void 0),o=i?2**-i.options.maxLevel:1,c=t.createLayer("feature",{features:["heatmap"]}),g=Ce(a,a.points.map(u=>u[3])),d=c.createFeature("heatmap",{style:{radius:(a.radius||25)*(a.scaleWithZoom?o:1),blurRadius:0,gaussian:!0,color:g.color,scaleWithZoom:a.scaleWithZoom||!1},position:u=>({x:u[0],y:u[1],z:u[2]}),intensity:u=>u[3]||0,minIntensity:g.min,maxIntensity:g.max,updateDelay:100}).data(a.points);return d._ownLayer=!0,[d]}function Et(a,e,n){const t=n.map(),i=t.createLayer("feature",{features:["heatmap"]}),o=(a.origin||[0,0,0])[0]||0,c=(a.origin||[0,0,0])[1]||0,g=(a.origin||[0,0,0])[2]||0,d=a.dx||1,u=a.dy||1,h=Ce(a,a.values),F=t.layers().find(v=>v instanceof window.geo.tileLayer&&v.options&&v.options.maxLevel!==void 0),y=F?2**-F.options.maxLevel:1,b=i.createFeature("heatmap",{style:{radius:(a.radius||25)*(a.scaleWithZoom?y:1),blurRadius:0,gaussian:!0,color:h.color,scaleWithZoom:a.scaleWithZoom||!1},position:(v,L)=>({x:o+d*(L%a.gridWidth),y:c+u*Math.floor(L/a.gridWidth),z:g}),intensity:v=>v||0,minIntensity:h.min,maxIntensity:h.max,updateDelay:100}).data(a.values);return b._ownLayer=!0,[b]}function xt(a,e,n){let t=a.values[0]||0,i=t;for(let c=1;c<a.values.length;c+=1)a.values[c]>i&&(i=a.values[c]),a.values[c]<i&&(t=a.values[c]);return t>=0&&(t=-1),[n.createFeature("contour",{style:{value:c=>c||0},contour:{gridWidth:a.gridWidth,x0:(a.origin||[])[0]||0,y0:(a.origin||[])[1]||0,dx:a.dx||1,dy:a.dy||1,stepped:!1,colorRange:[a.minColor||{r:0,g:0,b:1,a:1},a.zeroColor||{r:0,g:0,b:0,a:0},a.maxColor||{r:1,g:1,b:0,a:1}],rangeValues:[t,0,Math.max(0,i)]}}).data(a.values)]}const Me={griddata_contour:xt,griddata_heatmap:Et,heatmap:At};function Pe(a,e={},n){try{var t=[];return a.forEach(i=>{const o=Me[i.type+"_"+i.interpretation]||Me[i.type];o&&(t=t.concat(o(i,e,n)))}),t}catch(i){console.error(i)}}const jt=Object.freeze(Object.defineProperty({__proto__:null,convertFeatures:Pe,heatmapColorTable:Ce},Symbol.toStringTag,{value:"Module"})),te=girder._,Wt=girder.models.AccessControlledModel,{getCurrentUser:ne}=girder.auth,{restRequest:he}=girder.rest,$t=girder.models.MetadataMixin,re=Wt.extend({resourceName:"annotation",defaults:{annotation:{},minElements:5e3,maxDetails:25e4,maxCentroids:2e6},initialize(){!this.get("updated")&&ne()&&(this.attributes.updated=""+Date.now(),this.attributes.updatedId=ne().id),this._region={maxDetails:this.get("maxDetails"),minElements:this.get("minElements"),sort:"size",sortdir:-1},this._viewArea=3,this._elements=new ke(this.get("annotation").elements||[]),this._elements.annotation=this,this.listenTo(this._elements,"change add remove reset",()=>{var a=te.extend({},this.get("annotation"));a.elements=this._elements.toJSON(),this.set("annotation",a)})},fetchCentroids:function(){var a=(this.altUrl||this.resourceName)+"/"+this.get("_id"),e={url:a,data:{sort:"size",sortdir:-1,centroids:!0,limit:this.get("maxCentroids"),_:(this.get("updated")||this.get("created"))+"_"+this.get("_version")},xhrFields:{responseType:"arraybuffer"},error:null};return he(e).done(n=>{let t=new DataView(n),i=0,o=t.byteLength-1;for(;t.getUint8(i)&&i<t.byteLength;i+=1);for(;t.getUint8(o)&&o>=0;o-=1);if(i>=o)throw new Error("invalid centroid data");const c=new Uint8Array(i+t.byteLength-o-1);c.set(new Uint8Array(n.slice(0,i)),0),c.set(new Uint8Array(n.slice(o+1)),i);const g=JSON.parse(decodeURIComponent(escape(String.fromCharCode.apply(null,c)))),d={default:{fillColor:{r:1,g:120/255,b:0},fillOpacity:.8,strokeColor:{r:0,g:0,b:0},strokeOpacity:1,strokeWidth:1},rectangle:{fillColor:{r:176/255,g:222/255,b:92/255},strokeColor:{r:153/255,g:153/255,b:153/255},strokeWidth:2},ellipse:{fillColor:{r:176/255,g:222/255,b:92/255},strokeColor:{r:153/255,g:153/255,b:153/255},strokeWidth:2},circle:{fillColor:{r:176/255,g:222/255,b:92/255},strokeColor:{r:153/255,g:153/255,b:153/255},strokeWidth:2},polyline:{strokeColor:{r:1,g:120/255,b:0},strokeOpacity:.5,strokeWidth:4},polyline_closed:{fillColor:{r:176/255,g:222/255,b:92/255},strokeColor:{r:153/255,g:153/255,b:153/255},strokeWidth:2}};if(g.props=g._elementQuery.props.map(y=>{const b={};g._elementQuery.propskeys.forEach((L,I)=>{b[L]=y[I]}),Object.assign(b,ve(b));const v=b.type+(b.closed?"_closed":"");return["fillColor","strokeColor","strokeWidth","fillOpacity","strokeOpacity"].forEach(L=>{b[L]===void 0&&(b[L]=(d[v]||d.default)[L]),b[L]===void 0&&(b[L]=d.default[L])}),b}),t=new DataView(n,i+1,o-i-1),t.byteLength!==g._elementQuery.returned*28)throw new Error("invalid centroid data size");const u={id:new Array(g._elementQuery.returned),x:new Float32Array(g._elementQuery.returned),y:new Float32Array(g._elementQuery.returned),r:new Float32Array(g._elementQuery.returned),s:new Uint32Array(g._elementQuery.returned)};let h,F;for(h=F=0;F<t.byteLength;h+=1,F+=28)u.id[h]=("0000000"+t.getUint32(F,!1).toString(16)).substr(-8)+("0000000"+t.getUint32(F+4,!1).toString(16)).substr(-8)+("0000000"+t.getUint32(F+8,!1).toString(16)).substr(-8),u.x[h]=t.getFloat32(F+12,!0),u.y[h]=t.getFloat32(F+16,!0),u.r[h]=t.getFloat32(F+20,!0),u.s[h]=t.getUint32(F+24,!0);return g.centroids=u,g.data={length:g._elementQuery.returned},g._elementQuery.count>g._elementQuery.returned&&(g.partial=!0),this._centroids=g,g})},fetch:function(a){if(this.altUrl===null&&this.resourceName===null){alert("Error: You must set an altUrl or a resourceName on your model.");return}a=a||{};var e={url:(this.altUrl||this.resourceName)+"/"+this.get("_id"),data:Object.assign({},this._region,{_:(this.get("updated")||this.get("created"))+"_"+this.get("_version")})};return a.extraPath&&(e.url+="/"+a.extraPath),a.ignoreError&&(e.error=null),this._inFetch=!0,this._refresh&&(delete this._pageElements,delete this._centroids,this._refresh=!1),he(e).done(n=>{const i=(n.annotation||{}).elements||[];this.set(n),this._pageElements===void 0&&n._elementQuery&&(this._pageElements=n._elementQuery.count>n._elementQuery.returned,this._pageElements?(this._inFetch="centroids",this.fetchCentroids().then(()=>(this._inFetch=!0,a.extraPath?this.trigger("g:fetched."+a.extraPath):this.trigger("g:fetched"),null)).always(()=>{if(this._inFetch=!1,this._nextFetch){var o=this._nextFetch;this._nextFetch=null,o()}return null})):this._nextFetch=null),this._inFetch!=="centroids"&&(a.extraPath?this.trigger("g:fetched."+a.extraPath):this.trigger("g:fetched")),this._elements.reset(i,te.extend({sync:!0},a))}).fail(n=>{this.trigger("g:error",n)}).always(()=>{if(this._inFetch!=="centroids"&&(this._inFetch=!1,this._nextFetch)){var n=this._nextFetch;this._nextFetch=null,this._pageElements!==!1&&n()}})},refresh(a){return a===void 0?self._refresh:(self._refresh=a,this)},save(a){const e=te.extend({},this.get("annotation"));let n,t;const i=this.isNew();if(i){if(!this.get("itemId"))throw new Error("itemId is required to save new annotations");n=`annotation?itemId=${this.get("itemId")}`,t="POST"}else n=`annotation/${this.id}`,t="PUT",ne()&&(this.attributes.updated=""+Date.now(),this.attributes.updatedId=ne().id);return this._pageElements===!1||i?(this._pageElements=!1,e.elements=te.map(e.elements,o=>(o=te.extend({},o),o.label&&!o.label.value&&delete o.label,o))):(delete e.elements,this._pageElements===!0&&console.warn("Cannot save elements of a paged annotation")),he({url:n,method:t,contentType:"application/json",processData:!1,data:JSON.stringify(e)}).done(o=>{i&&(o.elements=(this.get("annotation")||{}).elements||[],this.set(o)),this.trigger("sync",this,o,a)})},destroy(a){return this.stopListening(),this.trigger("destroy",this,this.collection,a),this.delete(a)},name(){return(this.get("annotation")||{}).name},delete(a){this.trigger("g:delete",this,this.collection,a);let e=!1;return this.isNew()||(ne()&&(this.attributes.updated=""+Date.now(),this.attributes.updatedId=ne().id),e=he({url:`annotation/${this.id}`,method:"DELETE"})),this.unset("_id"),e},geojson(){const e=(this.get("annotation")||{}).elements||[];return Re(e,{annotation:this.id})},non_geojson(a){const n=(this.get("annotation")||{}).elements||[];return Pe(n,{annotation:this.id},a)},overlays(){const a=["image","pixelmap"];return((this.get("annotation")||{}).elements||[]).filter(t=>a.includes(t.type))},setView(a,e,n,t,i,o){if(!(this._pageElements===!1||this.isNew())){var c=a.right-a.left,g=a.bottom-a.top,d=c*(this._viewArea-1)/2,u=g*(this._viewArea-1)/2,h=d/2,F=u/2,y=this._region.left!==void 0&&a.left>=this._region.left+h&&a.top>=this._region.top+F&&a.right<=this._region.right-h&&a.bottom<=this._region.bottom-F&&Math.abs(this._lastZoom-e)<1;if(!(y&&!this._inFetch)){if(this._pageElements||this._region.left!==void 0){var b=Object.assign({},this._region);if(this._region.left=Math.max(0,a.left-d),this._region.top=Math.max(0,a.top-u),this._region.right=Math.min(i||1e6,a.right+d),this._region.bottom=Math.min(o||1e6,a.bottom+u),this._lastZoom=e,["left","top","right","bottom","minimumSize"].every(L=>this._region[L]===b[L]))return}if(!t&&!this._nextFetch){var v=()=>{this.fetch()};this._inFetch?this._nextFetch=v:v()}}}},elements(){return this._elements}});te.extend(re.prototype,$t);const Ot=girder.collections.Collection,{SORT_DESC:St}=girder.constants,ze=Ot.extend({resourceName:"annotation",model:re,pageLimit:1e4,sortField:"created",sortDir:St});function T(a,e,n,t){if(e===!1||e==null||!e&&(a==="class"||a==="style"))return"";if(e===!0)return" "+(a+'="'+a+'"');var i=typeof e;return i!=="object"&&i!=="function"||typeof e.toJSON!="function"||(e=e.toJSON()),typeof e=="string"||(e=JSON.stringify(e),n||e.indexOf('"')===-1)?(n&&(e=$(e))," "+a+'="'+e+'"'):" "+a+"='"+e.replace(/'/g,"&#39;")+"'"}function _e(a,e){return Array.isArray(a)?kt(a,e):a&&typeof a=="object"?Tt(a):a||""}function kt(a,e){for(var n,t="",i="",o=Array.isArray(e),c=0;c<a.length;c++)(n=_e(a[c]))&&(o&&e[c]&&(n=$(n)),t=t+i+n,i=" ");return t}function Tt(a){var e="",n="";for(var t in a)t&&a[t]&&It.call(a,t)&&(e=e+n+t,n=" ");return e}function $(a){var e=""+a,n=Rt.exec(e);if(!n)return a;var t,i,o,c="";for(t=n.index,i=0;t<e.length;t++){switch(e.charCodeAt(t)){case 34:o="&quot;";break;case 38:o="&amp;";break;case 60:o="&lt;";break;case 62:o="&gt;";break;default:continue}i!==t&&(c+=e.substring(i,t)),i=t+1,c+=o}return i!==t?c+e.substring(i,t):c}var It=Object.prototype.hasOwnProperty,Rt=/["&<>]/;function He(a,e,n,t){if(!(a instanceof Error))throw a;if(!(typeof window>"u"&&e||t))throw a.message+=" on line "+n,a;var i,o,c,g;try{t=t||require("fs").readFileSync(e,{encoding:"utf8"}),i=3,o=t.split(`
`),c=Math.max(n-i,0),g=Math.min(o.length,n+i)}catch(d){return a.message+=" - could not read from "+e+" ("+d.message+")",void He(a,null,n)}i=o.slice(c,g).map(function(d,u){var h=u+c+1;return(h==n?"  > ":"    ")+h+"| "+d}).join(`
`),a.path=e;try{a.message=(e||"Pug")+":"+n+`
`+i+`

`+a.message}catch{}throw a}function Mt(a){var e="",n,t,i;try{var o=a||{};(function(c,g,d,u,h,F,y,b,v,L,I){if(i=1,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+'<div class="g-annotation-list-header">',i=2,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+'<i class="icon-pencil"></i>',i=3,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+" Annotations",i=4,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+'<div class="btn-group pull-right">',i=5,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",b&&(i=6,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+'<a class="g-annotation-upload" title="Upload annotation">',i=7,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+'<i class="icon-upload"></i></a>'),i=8,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",u.length&&(i=9,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+"<a"+(' class="g-annotation-download"'+T("href",`${h}/annotation/item/${L.id}`,!0,!1)+' title="Download annotations"'+T("download",`${L.get("name")}_annotations.json`,!0,!1))+">",i=10,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+'<i class="icon-download"></i></a>'),i=11,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",d>=c.ADMIN&&u.length&&(i=12,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+'<a class="g-annotation-permissions" title="Adjust permissions">',i=13,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+'<i class="icon-lock"></i></a>',i=14,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+'<a class="g-annotation-delete" title="Delete">',i=15,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+'<i class="icon-cancel"></i></a>'),e=e+"</div></div>",i=17,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",u.length){i=18,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+'<table class="g-annotation-list table table-hover table-condensed">',i=19,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+"<thead>",i=20,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+"<!--",i=21,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+"th.g-annotation-select",i=22,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+`
`,i=22,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+"  input.g-select-all(type='checkbox')-->",i=23,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+'<th class="g-annotation-toggle">',i=24,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+"<a"+(T("class",_e(["g-annotation-toggle-all",F?"disabled":""],[!1,!0]),!1,!1)+' title="Hide or show all annotations"')+">",i=25,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug";let M=u.models.some(W=>v.has(W.id));i=26,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",M?(i=27,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+'<i class="icon-eye"></i>'):(i=29,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+'<i class="icon-eye-off"></i>'),e=e+"</a></th>",i=30,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",(function(){var W=y.columns||[];if(typeof W.length=="number")for(var R=0,D=W.length;R<D;R++){var m=W[R];i=31,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",(m.type!=="record"||m.value!=="controls")&&(i=32,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+'<th class="g-annotation-column">',i=33,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",m.title!==void 0?(i=34,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+$((n=m.title)==null?"":n)):(i=36,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+$((n=`${m.value.substr(0,1).toUpperCase()}${m.value.substr(1)}`)==null?"":n)),e=e+"</th>")}else{var D=0;for(var R in W){D++;var m=W[R];i=31,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",(m.type!=="record"||m.value!=="controls")&&(i=32,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+'<th class="g-annotation-column">',i=33,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",m.title!==void 0?(i=34,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+$((n=m.title)==null?"":n)):(i=36,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+$((n=`${m.value.substr(0,1).toUpperCase()}${m.value.substr(1)}`)==null?"":n)),e=e+"</th>")}}}).call(this),i=37,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+'<th class="g-annotation-actions"></th></thead>',i=38,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+"<tbody>",i=39,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",(function(){var W=u.models;if(typeof W.length=="number")for(var R=0,D=W.length;R<D;R++){var m=W[R];i=40,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug";var se=m.get("annotation").name,Z=I.get(m.get("creatorId")),z=Z?Z.get("login"):m.get("creatorId"),Q=I.get(m.get("updatedId")),J=Q?Q.get("login"):m.get("updatedId");i=46,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+"<tr"+(' class="g-annotation-row"'+T("data-annotation-id",m.id,!0,!1))+">",i=47,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+"<!--",i=48,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+"td.g-annotation-select",i=49,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+`
`,i=49,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+"  input(type='checkbox', title='Select annotation for bulk actions')-->",i=50,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+'<td class="g-annotation-toggle">',i=51,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+"<a"+(T("class",_e(["g-annotation-toggle-select",F?"disabled":""],[!1,!0]),!1,!1)+' title="Show annotation"')+">",i=52,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",v.has(m.id)?(i=53,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+'<i class="icon-eye"></i>'):(i=55,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+'<i class="icon-eye-off"></i>'),e=e+"</a></td>",i=56,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",(function(){var Y=y.columns||[];if(typeof Y.length=="number")for(var X=0,ue=Y.length;X<ue;X++){var C=Y[X];if(i=57,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",C.type!=="record"||C.value!=="controls"){i=58,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug";var E;C.type==="record"&&C.value==="creator"?E=z:C.type==="record"&&C.value==="updatedId"?E=J||z:C.type==="record"&&C.value==="updated"?E=E||m.get("created"):C.type==="metadata"?(E=m.get("annotation").attributes||{},C.value.split(".").forEach(le=>{E=(E||{})[le]})):E=C.type==="record"?m.get(C.value)||m.get("annotation")[C.value]:"",i=74,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+"<td"+(' class="g-annotation-entry"'+T("title",E,!0,!1))+">",i=75,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",C.format==="user"?(i=76,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+"<a"+T("href",`#user/${m.get(C.value)||m.get(C.value+"Id")}`,!0,!1)+">",i=77,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+$((n=E)==null?"":n)+"</a>"):C.format==="datetime"?(i=79,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+$((n=new g(E).toLocaleString())==null?"":n)):C.format==="date"?(i=81,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+$((n=new g(E).toLocaleDateString())==null?"":n)):C.format==="time"?(i=83,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+$((n=new g(E).toLocaleTimeString())==null?"":n)):(i=85,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+$((n=E)==null?"":n)),e=e+"</td>"}}else{var ue=0;for(var X in Y){ue++;var C=Y[X];if(i=57,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",C.type!=="record"||C.value!=="controls"){i=58,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug";var E;C.type==="record"&&C.value==="creator"?E=z:C.type==="record"&&C.value==="updatedId"?E=J||z:C.type==="record"&&C.value==="updated"?E=E||m.get("created"):C.type==="metadata"?(E=m.get("annotation").attributes||{},C.value.split(".").forEach(A=>{E=(E||{})[A]})):E=C.type==="record"?m.get(C.value)||m.get("annotation")[C.value]:"",i=74,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+"<td"+(' class="g-annotation-entry"'+T("title",E,!0,!1))+">",i=75,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",C.format==="user"?(i=76,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+"<a"+T("href",`#user/${m.get(C.value)||m.get(C.value+"Id")}`,!0,!1)+">",i=77,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+$((n=E)==null?"":n)+"</a>"):C.format==="datetime"?(i=79,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+$((n=new g(E).toLocaleString())==null?"":n)):C.format==="date"?(i=81,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+$((n=new g(E).toLocaleDateString())==null?"":n)):C.format==="time"?(i=83,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+$((n=new g(E).toLocaleTimeString())==null?"":n)):(i=85,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+$((n=E)==null?"":n)),e=e+"</td>"}}}}).call(this),i=86,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+'<td class="g-annotation-actions">',i=87,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+"<!--",i=88,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+"if annotation.get('_accessLevel') >= AccessType.WRITE",i=89,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+`
`,i=89,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+"  a.g-annotation-edit(title='Edit annotation')",i=90,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+`
`,i=90,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+"    i.icon-cog-->",i=91,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+"<a"+(' class="g-annotation-download"'+T("href",`${h}/annotation/${m.id}`,!0,!1)+' title="Download"'+T("download",`${se}.json`,!0,!1))+">",i=92,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+'<i class="icon-download"></i></a>',i=93,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",m.get("_accessLevel")>=c.ADMIN&&(i=94,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+'<a class="g-annotation-permissions" title="Adjust permissions">',i=95,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+'<i class="icon-lock"></i></a>'),i=96,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",m.get("_accessLevel")>=c.WRITE&&(i=97,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+'<a class="g-annotation-delete" title="Delete">',i=98,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+'<i class="icon-cancel"></i></a>'),e=e+"</td></tr>"}else{var D=0;for(var R in W){D++;var m=W[R];i=40,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug";var se=m.get("annotation").name,Z=I.get(m.get("creatorId")),z=Z?Z.get("login"):m.get("creatorId"),Q=I.get(m.get("updatedId")),J=Q?Q.get("login"):m.get("updatedId");i=46,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+"<tr"+(' class="g-annotation-row"'+T("data-annotation-id",m.id,!0,!1))+">",i=47,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+"<!--",i=48,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+"td.g-annotation-select",i=49,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+`
`,i=49,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+"  input(type='checkbox', title='Select annotation for bulk actions')-->",i=50,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+'<td class="g-annotation-toggle">',i=51,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+"<a"+(T("class",_e(["g-annotation-toggle-select",F?"disabled":""],[!1,!0]),!1,!1)+' title="Show annotation"')+">",i=52,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",v.has(m.id)?(i=53,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+'<i class="icon-eye"></i>'):(i=55,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+'<i class="icon-eye-off"></i>'),e=e+"</a></td>",i=56,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",(function(){var q=y.columns||[];if(typeof q.length=="number")for(var A=0,G=q.length;A<G;A++){var w=q[A];if(i=57,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",w.type!=="record"||w.value!=="controls"){i=58,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug";var x;w.type==="record"&&w.value==="creator"?x=z:w.type==="record"&&w.value==="updatedId"?x=J||z:w.type==="record"&&w.value==="updated"?x=x||m.get("created"):w.type==="metadata"?(x=m.get("annotation").attributes||{},w.value.split(".").forEach($e=>{x=(x||{})[$e]})):x=w.type==="record"?m.get(w.value)||m.get("annotation")[w.value]:"",i=74,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+"<td"+(' class="g-annotation-entry"'+T("title",x,!0,!1))+">",i=75,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",w.format==="user"?(i=76,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+"<a"+T("href",`#user/${m.get(w.value)||m.get(w.value+"Id")}`,!0,!1)+">",i=77,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+$((n=x)==null?"":n)+"</a>"):w.format==="datetime"?(i=79,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+$((n=new g(x).toLocaleString())==null?"":n)):w.format==="date"?(i=81,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+$((n=new g(x).toLocaleDateString())==null?"":n)):w.format==="time"?(i=83,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+$((n=new g(x).toLocaleTimeString())==null?"":n)):(i=85,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+$((n=x)==null?"":n)),e=e+"</td>"}}else{var G=0;for(var A in q){G++;var w=q[A];if(i=57,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",w.type!=="record"||w.value!=="controls"){i=58,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug";var x;w.type==="record"&&w.value==="creator"?x=z:w.type==="record"&&w.value==="updatedId"?x=J||z:w.type==="record"&&w.value==="updated"?x=x||m.get("created"):w.type==="metadata"?(x=m.get("annotation").attributes||{},w.value.split(".").forEach(fe=>{x=(x||{})[fe]})):x=w.type==="record"?m.get(w.value)||m.get("annotation")[w.value]:"",i=74,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+"<td"+(' class="g-annotation-entry"'+T("title",x,!0,!1))+">",i=75,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",w.format==="user"?(i=76,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+"<a"+T("href",`#user/${m.get(w.value)||m.get(w.value+"Id")}`,!0,!1)+">",i=77,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+$((n=x)==null?"":n)+"</a>"):w.format==="datetime"?(i=79,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+$((n=new g(x).toLocaleString())==null?"":n)):w.format==="date"?(i=81,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+$((n=new g(x).toLocaleDateString())==null?"":n)):w.format==="time"?(i=83,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+$((n=new g(x).toLocaleTimeString())==null?"":n)):(i=85,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+$((n=x)==null?"":n)),e=e+"</td>"}}}}).call(this),i=86,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+'<td class="g-annotation-actions">',i=87,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+"<!--",i=88,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+"if annotation.get('_accessLevel') >= AccessType.WRITE",i=89,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+`
`,i=89,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+"  a.g-annotation-edit(title='Edit annotation')",i=90,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+`
`,i=90,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+"    i.icon-cog-->",i=91,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+"<a"+(' class="g-annotation-download"'+T("href",`${h}/annotation/${m.id}`,!0,!1)+' title="Download"'+T("download",`${se}.json`,!0,!1))+">",i=92,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+'<i class="icon-download"></i></a>',i=93,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",m.get("_accessLevel")>=c.ADMIN&&(i=94,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+'<a class="g-annotation-permissions" title="Adjust permissions">',i=95,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+'<i class="icon-lock"></i></a>'),i=96,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",m.get("_accessLevel")>=c.WRITE&&(i=97,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+'<a class="g-annotation-delete" title="Delete">',i=98,t="/root/project/girder_annotation/girder_large_image_annotation/web_client/templates/annotationListWidget.pug",e=e+'<i class="icon-cancel"></i></a>'),e=e+"</td></tr>"}}}).call(this),e=e+"</tbody></table>"}}).call(this,"AccessType"in o?o.AccessType:typeof AccessType<"u"?AccessType:void 0,"Date"in o?o.Date:typeof Date<"u"?Date:void 0,"accessLevel"in o?o.accessLevel:typeof accessLevel<"u"?accessLevel:void 0,"annotations"in o?o.annotations:typeof annotations<"u"?annotations:void 0,"apiRoot"in o?o.apiRoot:typeof apiRoot<"u"?apiRoot:void 0,"canDraw"in o?o.canDraw:typeof canDraw<"u"?canDraw:void 0,"confList"in o?o.confList:typeof confList<"u"?confList:void 0,"creationAccess"in o?o.creationAccess:typeof creationAccess<"u"?creationAccess:void 0,"drawn"in o?o.drawn:typeof drawn<"u"?drawn:void 0,"item"in o?o.item:typeof item<"u"?item:void 0,"users"in o?o.users:typeof users<"u"?users:void 0)}catch(c){He(c,t,i)}return e}const B=girder.$,Ue=girder._,{AccessType:Pt}=girder.constants,Ve=girder.utilities.EventStream,{getCurrentUser:zt}=girder.auth,{confirm:De}=girder.dialog,{getApiRoot:Ht,restRequest:Ne}=girder.rest,Ut=girder.views.widgets.AccessWidget,Vt=girder.events,Dt=girder.collections.UserCollection,Nt=girder.views.widgets.UploadWidget,Bt=girder.views.View.extend({events:{"click .g-annotation-toggle-select":"_displayAnnotation","click .g-annotation-toggle-all":"_displayAllAnnotations","click .g-annotation-delete":"_deleteAnnotation","click .g-annotation-upload":"_uploadAnnotation","click .g-annotation-permissions":"_changePermissions","click .g-annotation-metadata":"_annotationMetadata","click .g-annotation-row"(a){var e=B(a.currentTarget);e.find(".g-annotation-toggle-select").click()},"click .g-annotation-row a,.g-annotation-toggle-select"(a){a.stopPropagation()}},initialize(){this._drawn=new Set,this._viewer=null,this._sort={field:"name",direction:1},this.collection=this.collection||new ze([],{comparator:null}),this.users=new Dt,this.listenTo(this.collection,"all",this.render),this.listenTo(this.users,"all",this.render),this.listenTo(Ve,"g:event.large_image_annotation.create",()=>this.collection.fetch(null,!0)),this.listenTo(Ve,"g:event.large_image_annotation.remove",()=>this.collection.fetch(null,!0)),Ne({type:"GET",url:"annotation/folder/"+this.model.get("folderId")+"/create",error:null}).done(a=>{this.createResp=a,girder.plugins.large_image.views.ConfigView.getConfigFile(this.model.get("folderId")).done(e=>{this._liconfig=e||{},this._confList=this._liconfig.annotationList||{columns:[{type:"record",value:"name"},{type:"record",value:"creator",format:"user"},{type:"record",value:"created",format:"date"}]},this.collection.comparator=Ue.constant(0),this._lastSort=this._confList.defaultSort||[{type:"record",value:"updated",dir:"up"},{type:"record",value:"updated",dir:"down"}],this.collection.sortField=JSON.stringify(this._lastSort.reduce((n,t)=>(n.push([(t.type==="metadata"?"annotation.attributes.":"")+t.value,t.dir==="down"?1:-1]),t.type==="record"&&n.push([`annotation.${t.value}`,t.dir==="down"?1:-1]),n),[])),this.collection.fetch({itemId:this.model.id,sort:this.collection.sortField||"created",sortdir:-1}).done(()=>{this._fetchUsers()})})})},render(){return this.$el.html(Mt({item:this.model,accessLevel:this.model.getAccessLevel(),creationAccess:this.createResp,annotations:this.collection,users:this.users,canDraw:this._viewer&&this._viewer.annotationAPI(),drawn:this._drawn,apiRoot:Ht(),confList:this._confList,AccessType:Pt})),this},setViewer(a){return this._drawn.clear(),this._viewer=a,this},_displayAnnotation(a){if(!this._viewer||!this._viewer.annotationAPI())return;const e=B(a.currentTarget).closest(".g-annotation-row"),n=e.data("annotationId"),t=this.collection.get(n),i=e.find(".g-annotation-toggle-select i.icon-eye").length;i?(this._drawn.delete(n),this._viewer.removeAnnotation(t)):(this._drawn.add(n),t.fetch().then(()=>(this._drawn.has(n)&&this._viewer.drawAnnotation(t),null))),e.find(".g-annotation-toggle-select i").toggleClass("icon-eye",!i).toggleClass("icon-eye-off",!!i);const o=this.collection.some(c=>this._drawn.has(c.id));this.$el.find("th.g-annotation-toggle i").toggleClass("icon-eye",!!o).toggleClass("icon-eye-off",!o)},_displayAllAnnotations(a){if(!this._viewer||!this._viewer.annotationAPI())return;const e=this.collection.some(n=>this._drawn.has(n.id));this.collection.forEach(n=>{const t=n.id;let i=this._drawn.has(n.id);e&&i?(this._drawn.delete(t),this._viewer.removeAnnotation(n),i=!1):!e&&!i&&(this._drawn.add(t),n.fetch().then(()=>(this._drawn.has(t)&&this._viewer.drawAnnotation(n),null)),i=!0),this.$el.find(`.g-annotation-row[data-annotation-id="${t}"] .g-annotation-toggle-select i`).toggleClass("icon-eye",!!i).toggleClass("icon-eye-off",!i)}),this.$el.find("th.g-annotation-toggle i").toggleClass("icon-eye",!e).toggleClass("icon-eye-off",!!e)},_deleteAnnotation(a){const n=B(a.currentTarget).parents(".g-annotation-row").data("annotationId");if(!n){De({text:"Are you sure you want to delete <b>ALL</b> annotations?",escapedHtml:!0,yesText:"Delete",confirmCallback:()=>{Ne({url:`annotation/item/${this.model.id}`,method:"DELETE"}).done(()=>{this.collection.fetch(null,!0)})}});return}const t=this.collection.get(n);De({text:`Are you sure you want to delete <b>${Ue.escape(t.get("annotation").name)}</b>?`,escapedHtml:!0,yesText:"Delete",confirmCallback:()=>{this._drawn.delete(n),t.destroy()}})},_uploadAnnotation(){var a=new Nt({el:B("#g-dialog-container"),title:"Upload Annotation",parent:this.model,parentType:"item",parentView:this,multiFile:!0,otherParams:{reference:JSON.stringify({identifier:"LargeImageAnnotationUpload",itemId:this.model.id,fileId:this.model.get("largeImage")&&this.model.get("largeImage").fileId,userId:(zt()||{}).id})}}).on("g:uploadFinished",()=>{Vt.trigger("g:alert",{icon:"ok",text:"Uploaded annotations.",type:"success",timeout:4e3}),this.collection.fetch(null,!0)},this);this._uploadWidget=a,a.render()},_changePermissions(a){let n=B(a.currentTarget).parents(".g-annotation-row").data("annotationId");!n&&this.collection.length===1&&(n=this.collection.at(0).id);const t=n?this.collection.get(n):this.collection.at(0).clone();n||(t.get("annotation").name="All Annotations",t.save=()=>{},t.updateAccess=()=>{const i={access:t.get("access"),public:t.get("public"),publicFlags:t.get("publicFlags")};this.collection.each(o=>{o.set(i),o.updateAccess()}),this.collection.fetch(null,!0),t.trigger("g:accessListSaved")}),new Ut({el:B("#g-dialog-container"),type:"annotation",hideRecurseOption:!0,parentView:this,model:t,noAccessFlag:!0}).on("g:accessListSaved",()=>{this.collection.fetch(null,!0)})},_fetchUsers(){this.collection.each(a=>{this.users.add({_id:a.get("creatorId")}),this.users.add({_id:a.get("updatedId")})}),B.when.apply(B,this.users.map(a=>a.fetch())).always(()=>{this.render()})}}),Le=girder._,{wrap:Ae}=girder.utilities.PluginUtils;girder.events.on("g:appload.before",function(){const a=girder.plugins.large_image.views.ImageViewerSelectWidget;Ae(a,"initialize",function(e,n){this.itemId=n.imageModel.id,this.model=n.imageModel,this._annotationList=new Bt({model:this.model,parentView:this}),e.apply(this,Le.rest(arguments))}),Ae(a,"render",function(e){return e.apply(this,Le.rest(arguments)),this.$el.append(ct()),this._annotationList.setViewer(this.currentViewer).setElement(this.$(".g-annotation-list-container")).render(),this}),Ae(a,"_selectViewer",function(e){return e.apply(this,Le.rest(arguments)),this._annotationList.setViewer(this.currentViewer).render(),this})});const qt=girder._;function oe(a,e){return e=e||a.type(),qt.extend({},we[e]||{})}function Ee(a){return[a.x,a.y,a.z||0]}const Gt=girder._;function Zt(a){const e=oe(a);return Gt.extend(e,{type:"point",center:Ee(a.coordinates()[0])})}const Qt=girder._;function xe(a){const e=oe(a);let n=a.coordinates(),t=[Math.atan2(n[1].y-n[0].y,n[1].x-n[0].x),Math.atan2(n[2].y-n[1].y,n[2].x-n[1].x),Math.atan2(n[3].y-n[2].y,n[3].x-n[2].x),Math.atan2(n[0].y-n[3].y,n[0].x-n[3].x)],i=t.indexOf(Math.min(...t));t[(i+1)%4]-t[i]>Math.PI&&(n=[n[0],n[3],n[2],n[1]],t=[Math.atan2(n[1].y-n[0].y,n[1].x-n[0].x),Math.atan2(n[2].y-n[1].y,n[2].x-n[1].x),Math.atan2(n[3].y-n[2].y,n[3].x-n[2].x),Math.atan2(n[0].y-n[3].y,n[0].x-n[3].x)],i=t.indexOf(Math.min(...t))),t[i]<-.75*Math.PI&&(i+=1);const o=n[i%4],c=n[(i+1)%4],g=n[(i+2)%4],d=n[(i+3)%4],u=[g.x-c.x,g.y-c.y],h=[c.x-o.x,c.y-o.y],F=Math.atan2(u[1],u[0]),y=Math.sqrt(h[0]*h[0]+h[1]*h[1]),b=Math.sqrt(u[0]*u[0]+u[1]*u[1]),v=[.25*(o.x+c.x+g.x+d.x),.25*(o.y+c.y+g.y+d.y),0];return Qt.extend(e,{type:"rectangle",center:v,width:b,height:y,rotation:F})}function Jt(a){const e=xe(a);return e.type="ellipse",e}function Yt(a){const e=xe(a);return e.type="circle",e.radius=Math.max(e.width,e.height)/2,delete e.width,delete e.height,delete e.rotation,delete e.normal,e}const Xt=girder._;function Fe(a){return Xt.map(a,Ee)}const Kt=girder._;function en(a){const e=oe(a,"polyline");let n=a.coordinates();const t=n.inner?n.inner.map(i=>Fe(i)):void 0;return n=Fe(n.outer||n),Kt.extend(e,{type:"polyline",closed:!0,points:n,holes:t})}const tn=girder._;function nn(a){const e=oe(a,"polyline"),n=Fe(a.coordinates());return tn.extend(e,{type:"polyline",closed:!!a.style("closed"),points:n})}const je=Object.freeze(Object.defineProperty({__proto__:null,circle:Yt,ellipse:Jt,line:nn,point:Zt,polygon:en,rectangle:xe},Symbol.toStringTag,{value:"Module"})),an=Object.freeze(Object.defineProperty({__proto__:null,array:Fe,point:Ee},Symbol.toStringTag,{value:"Module"})),rn=girder._;function Be(a){var e=a.type();if(!rn.has(je,e))throw new Error(`Unknown annotation type "${e}"`);return je[e](a)}const on=Object.freeze(Object.defineProperty({__proto__:null,convert:Re,convertFeatures:jt,defaults:we,geojs:Object.freeze(Object.defineProperty({__proto__:null,common:oe,convert:Be,coordinates:an,types:je},Symbol.toStringTag,{value:"Module"})),geometry:be,rotate:me,style:ve},Symbol.toStringTag,{value:"Module"})),sn=Object.freeze(Object.defineProperty({__proto__:null,AnnotationCollection:ze,ElementCollection:ke},Symbol.toStringTag,{value:"Module"})),un=Object.freeze(Object.defineProperty({__proto__:null,AnnotationModel:re},Symbol.toStringTag,{value:"Module"})),ln=girder.$,{wrap:gn}=girder.utilities.PluginUtils,qe=girder.views.widgets.HierarchyWidget,{restRequest:Ge}=girder.rest,cn=girder.views.widgets.AccessWidget;gn(qe,"render",function(a){a.call(this),this.parentModel.get("_modelType")==="folder"&&dn(this,this.parentModel.id)});function dn(a,e){Ge({type:"GET",url:"annotation/folder/"+e+"/present",data:{recurse:!0}}).done(n=>{n&&hn(a)})}function hn(a){a.$(".g-edit-annotation-access").length===0&&(a.$(".g-folder-actions-menu > .divider").length>0?a.$(".g-folder-actions-menu > .divider").before('<li role="presentation"><a class="g-edit-annotation-access" role="menuitem"><i class="icon-lock"></i>Annotation access control</a></li>'):a.$("ul.g-folder-actions-menu").append('<li role="presentation"><a class="g-edit-annotation-access" role="menuitem"><i class="icon-lock"></i>Annotation access control</a></li>'),a.events["click .g-edit-annotation-access"]=_n,a.delegateEvents())}function _n(){Ge({type:"GET",url:"annotation/folder/"+this.parentModel.get("_id"),data:{recurse:!0,limit:1}}).done(a=>{const e=new re(a[0]);e.get("annotation").name="Your Annotations",e.save=()=>{},e.updateAccess=n=>{const t={access:e.get("access"),public:e.get("public"),publicFlags:e.get("publicFlags")},i=new re;i.id=this.parentModel.get("_id"),i.altUrl="annotation/folder",i.set(t),i.updateAccess(n),e.trigger("g:accessListSaved")},e.fetchAccess(!0).done(()=>{new cn({el:ln("#g-dialog-container"),modelType:"annotation",model:e,hideRecurseOption:!1,parentView:this,noAccessFlag:!0})})})}const We=girder.$,Ze=girder._,{restRequest:Fn}=girder.rest,{wrap:pn}=girder.utilities.PluginUtils,Qe=girder.views.widgets.ItemListWidget;pn(Qe,"render",function(a){a.apply(this,Ze.rest(arguments));function e(n,t,i,o){const c=We('.large_image_thumbnail[g-item-cid="'+n.cid+'"]',t).first();if(!c.length)return;let g=c.find(".large_image_annotation_badge");g.length===0&&(g=We('<div class="large_image_annotation_badge hidden"></div>').appendTo(c)),g.attr("title",o?"Referenced by an annotation":`${i} annotation${i===1?"":"s"}`).text(i).toggleClass("hidden",!i)}K.getSettings(n=>{if(n["large_image.show_thumbnails"]===!1||this.$(".large_image_annotation_badge").length>0)return;const t=this.collection.toArray();if(!Ze.some(t,g=>g.has("largeImage"))||this._inFetch||this._needsFetch)return;const o=t.filter(g=>g._annotationCount===void 0&&g.has("largeImage")).map(g=>(g._annotationCount=null,delete g._annotationReferenced,g.id));let c;o.length?c=Fn({type:"POST",url:"annotation/counts",data:{items:o.join(",")},headers:{"X-HTTP-Method-Override":"GET"},error:null}).done(g=>{Object.entries(g).forEach(([d,u])=>{d==="referenced"?Object.keys(u).forEach(h=>{this.collection.get(h)&&(this.collection.get(h)._annotationReferenced=!0)}):this.collection.get(d)&&(this.collection.get(d)._annotationCount=u)})}):c=We.Deferred().resolve({}),c.then(()=>(this.collection.forEach(g=>{g._annotationCount!==void 0&&(g._annotationReferenced?e(g,this.$el,"*",!0):e(g,this.$el,g._annotationCount))}),null))})});var Je={annotationAPI:girder._.constant(!1),drawAnnotation:function(){throw new Error("Viewer does not support drawing annotations")},removeAnnotation:function(){throw new Error("Viewer does not support drawing annotations")},drawRegion:function(){throw new Error("Viewer does not support drawing annotations")},startDrawMode:function(){throw new Error("Viewer does not support drawing annotations")}};const fn=girder.$,O=girder._,mn=girder.Backbone,ie=girder.events,{wrap:yn}=girder.utilities.PluginUtils,{restRequest:bn}=girder.rest;function Ye(){function a(){return Math.floor((1+Math.random())*65536).toString(16).substring(1)}return a()+a()+a()+a()+a()+a()}var wn=function(a){return yn(a,"initialize",function(e){var n=arguments[1];return this._annotations={},this._featureOpacity={},this._unclampBoundsForOverlay=!0,this._globalAnnotationOpacity=n.globalAnnotationOpacity||1,this._globalAnnotationFillOpacity=n.globalAnnotationFillOpacity||1,this._highlightFeatureSizeLimit=n.highlightFeatureSizeLimit||1e4,this.listenTo(ie,"s:widgetDrawRegionEvent",this.drawRegion),this.listenTo(ie,"s:widgetClearRegion",this.clearRegion),this.listenTo(ie,"g:startDrawMode",this.startDrawMode),this._hoverEvents=n.hoverEvents,e.apply(this,O.rest(arguments))}),{_postRender:function(){this.featureLayer=this.viewer.createLayer("feature",{features:["point","line","polygon","marker"]}),this.setGlobalAnnotationOpacity(this._globalAnnotationOpacity),this.setGlobalAnnotationFillOpacity(this._globalAnnotationFillOpacity),this.annotationLayer=this.viewer.createLayer("annotation",{annotations:["point","line","rectangle","ellipse","circle","polygon"],showLabels:!1});var e=window.geo;this.viewer.geoOn(e.event.pan,()=>{this.setBounds()})},annotationAPI:O.constant(!0),getUnclampBoundsForOverlay:function(){return this._unclampBoundsForOverlay},setUnclampBoundsForOverlay:function(e){this._unclampBoundsForOverlay=e},_getOverlayTransformProjString:function(e){const n=e.transform||{};let t=n.xoffset||0,i=n.yoffset||0;const o=n.matrix||[[1,0],[0,1]];let c=o[0][0],g=o[0][1],d=o[1][0],u=o[1][1];const h=2**this._getOverlayRelativeScale(e);h&&h!==1&&(c/=h,g/=h,d/=h,u/=h,t*=h,i*=h);let F="+proj=longlat +axis=enu";return t!==0&&(t=-1*t,F=F+` +xoff=${t}`),i!==0&&(F=F+` +yoff=${i}`),(c!==1||g!==0||d!==0||u!==1)&&(F=F+` +s11=${1/c} +s12=${g} +s21=${d} +s22=${1/u}`),F},_getOverlayRelativeScale:function(e){const t=(e.transform||{}).matrix||[[1,0],[0,1]],i=t[0][0],o=t[0][1],c=t[1][0],g=t[1][1],d=Math.sqrt(Math.abs(i*g-o*c))||1;return Math.floor(Math.log2(d))},_countDrawnImageOverlays:function(){let e=0;return O.each(this._annotations,(n,t,i)=>{const o=n.overlays||[];e+=o.length}),e},_addPixelmapLayerParams(e,n,t){e.keepLower=!1,O.isFunction(e.url)||t?e.url=(g,d,u)=>"api/v1/item/"+n.girderId+`/tiles/zxy/${u-t}/${g}/${d}?encoding=PNG`:e.url=e.url+"?encoding=PNG";let i=n.values;if(n.boundaries){const g=new Array(i.length*2);for(let d=0;d<i.length;d++)g[d*2]=g[d*2+1]=i[d];i=g}e.data=i;const o=n.categories,c=n.boundaries;return e.style={color:(g,d)=>{if(g<0||g>=o.length)return console.warn(`No category found at index ${g} in the category map.`),"rgba(0, 0, 0, 0)";let u;const h=o[g];return c?u=d%2===0?h.fillColor:h.strokeColor:u=h.fillColor,u}},e},_generateOverlayLayerParams(e,n,t){const o=window.geo.util.pixelCoordinateParams(this.viewer.node(),e.sizeX,e.sizeY,e.tileWidth,e.tileHeight);o.layer.useCredentials=!0,o.layer.url=`api/v1/item/${n}/tiles/zxy/{z}/{x}/{y}`,this._countDrawnImageOverlays()<=6?o.layer.autoshareRenderer=!1:o.layer.renderer="canvas",o.layer.opacity=t.opacity||1,o.layer.opacity*=this._globalAnnotationOpacity;let c=this.levels-e.levels;return c-=this._getOverlayRelativeScale(t),this.levels!==e.levels&&(o.layer.url=(g,d,u)=>"api/v1/item/"+n+`/tiles/zxy/${u-c}/${g}/${d}`,o.layer.minLevel=c,o.layer.maxLevel+=c,o.layer.tilesMaxBounds=g=>{var d=Math.pow(2,o.layer.maxLevel-g);return{x:Math.floor(e.sizeX/d),y:Math.floor(e.sizeY/d)}},o.layer.tilesAtZoom=g=>{var d=Math.pow(2,o.layer.maxLevel-g);return{x:Math.ceil(e.sizeX/e.tileWidth/d),y:Math.ceil(e.sizeY/e.tileHeight/d)}}),t.type==="pixelmap"?o.layer=this._addPixelmapLayerParams(o.layer,t,c):t.hasAlpha&&(o.layer.keepLower=!1,o.layer.url=(g,d,u)=>"api/v1/item/"+n+`/tiles/zxy/${u-c}/${g}/${d}?encoding=PNG`),o.layer},drawAnnotation:function(e,n){if(!this.viewer)return;var t=window.geo;n=O.defaults(n||{},{fetch:!0});var i=e.geojson();const o=e.overlays()||[];var c=O.has(this._annotations,e.id),g;let d=!1;if(c&&(O.each(this._annotations[e.id].features,(h,F)=>{F||!e._centroids||h.data().length!==e._centroids.data.length?h._ownLayer?h.layer().map().deleteLayer(h.layer()):(this.featureLayer.deleteFeature(h),d=!0):g=h}),this._annotations[e.id].overlays&&O.each(this._annotations[e.id].overlays,h=>{const F=this._annotations[e.id].overlays.map(b=>b.id),y=o.map(b=>b.id);O.each(F,b=>{if(!y.includes(b)){const v=this.viewer.layers().find(L=>L.id()===b);this.viewer.deleteLayer(v)}})})),this._annotations[e.id]={features:g?[g]:[],options:n,annotation:e,overlays:o},!(n.fetch&&(!c||e.refresh()||e._inFetch==="centroids")&&(e.off("g:fetched",null,this).on("g:fetched",()=>{this.trigger("g:mouseResetAnnotation",e),this.drawAnnotation(e)},this),this.setBounds({[e.id]:this._annotations[e.id]}),e._inFetch==="centroids"))){e.refresh(!1);var u=this._annotations[e.id].features;if(e._centroids&&!g){const h=this.featureLayer.createFeature("point");u.push(h),h.data(e._centroids.data).position((F,y)=>({x:e._centroids.centroids.x[y],y:e._centroids.centroids.y[y]})).style({radius:(F,y)=>{let b=e._centroids.centroids.r[y];return b?(b/=2.5*this.viewer.unitsPerPixel(this.viewer.zoom()),b):8},stroke:(F,y)=>!e._shownIds||!e._shownIds.has(e._centroids.centroids.id[y]),strokeColor:(F,y)=>{const b=e._centroids.centroids.s[y];return e._centroids.props[b].strokeColor},strokeOpacity:(F,y)=>{const b=e._centroids.centroids.s[y];return e._centroids.props[b].strokeOpacity},strokeWidth:(F,y)=>{const b=e._centroids.centroids.s[y];return e._centroids.props[b].strokeWidth},fill:(F,y)=>!e._shownIds||!e._shownIds.has(e._centroids.centroids.id[y]),fillColor:(F,y)=>{const b=e._centroids.centroids.s[y];return e._centroids.props[b].fillColor},fillOpacity:(F,y)=>{const b=e._centroids.centroids.s[y];return e._centroids.props[b].fillOpacity}}),e._centroidLastZoom=void 0,h.geoOn(t.event.pan,()=>{if(this.viewer.zoom()!==e._centroidLastZoom)if(e._centroidLastZoom=this.viewer.zoom(),h.verticesPerFeature){const v=2.5*this.viewer.unitsPerPixel(this.viewer.zoom()),L=h.verticesPerFeature(),I=h.data().length,M=new Float32Array(L*I);for(var F=0,y=0;F<I;F+=1){let W=e._centroids.centroids.r[F];W?W/=v:W=8;for(var b=0;b<L;b+=1,y+=1)M[y]=W}h.updateStyleFromArray("radius",M,!0)}else h.modified().draw()})}this.getUnclampBoundsForOverlay()&&this._annotations[e.id].overlays.length>0&&(this.viewer.clampBoundsY(!1),this.viewer.clampBoundsX(!1)),O.each(this._annotations[e.id].overlays,h=>{const F=h.girderId;bn({url:`item/${F}/tiles`}).done(y=>{if(!this.viewer)return;const b=this.viewer.layers().filter(R=>R.id()===h.id);b.length>0&&O.each(b,R=>{this.viewer.deleteLayer(R)});const v=this._generateOverlayLayerParams(y,F,h),L=h.type==="pixelmap"?"pixelmap":"osm",I=this._getOverlayTransformProjString(h),M=this.viewer.createLayer(L,Object.assign({},v,{id:h.id,gcs:I}));this.annotationLayer.moveToTop(),this.trigger("g:drawOverlayAnnotation",h,M);const W=t.event.feature;M.geoOn([W.mousedown,W.mouseup,W.mouseclick,W.mouseoff,W.mouseon,W.mouseover,W.mouseout],R=>this._onMouseFeature(R,e.elements().get(h.id),M)),this.viewer.scheduleAnimationFrame(this.viewer.draw,!0)}).fail(y=>{console.error(`There was an error overlaying image with ID ${F}`)})}),this._featureOpacity[e.id]={},t.createFileReader("geojsonReader",{layer:this.featureLayer}).read(i,h=>{h.length===0&&(h=e.non_geojson(this.featureLayer),h.length&&this.featureLayer.map().draw()),O.each(h||[],F=>{var y=t.event.feature;u.push(F),F.selectionAPI(this._hoverEvents),F.geoOn([y.mousedown,y.mouseup,y.mouseclick,y.mouseoff,y.mouseon,y.mouseover,y.mouseout],v=>this._onMouseFeature(v));const b=F.data();e._centroids&&(e._shownIds=new Set(F.data().map(v=>v.id))),b.length<=this._highlightFeatureSizeLimit&&!e._centroids&&(this._featureOpacity[e.id][F.featureType]=F.data().map(({id:v,properties:L})=>({id:v,fillOpacity:L.fillOpacity,strokeOpacity:L.strokeOpacity})))}),this._mutateFeaturePropertiesForHighlight(e.id,h),e._centroids&&u[0]&&(u[0].verticesPerFeature?this.viewer.scheduleAnimationFrame(()=>{const F=u[0].verticesPerFeature(),y=u[0].data().length,b=new Float32Array(F*y);for(let v=0,L=0;v<y;v+=1){const I=e._shownIds.has(e._centroids.centroids.id[v])?0:1;for(let M=0;M<F;M+=1,L+=1)b[L]=I}u[0].updateStyleFromArray({stroke:b,fill:b},void 0,!0)}):u[0].modified()),this.viewer.scheduleAnimationFrame(this.viewer.draw,!0)}),d&&this.featureLayer._update()}},highlightAnnotation:function(e,n){return(e!==this._highlightAnnotation||n!==this._highlightElement)&&(this._highlightAnnotation=e,this._highlightElement=n,O.each(this._annotations,(t,i)=>{const o=t.features;this._mutateFeaturePropertiesForHighlight(i,o)}),this.viewer.scheduleAnimationFrame(this.viewer.draw)),this},hideAnnotation:function(e,n){return this._hideAnnotation=e,this._hideElement=n,O.each(this._annotations,(t,i)=>{const o=t.features;this._mutateFeaturePropertiesForHighlight(i,o)}),this.viewer.scheduleAnimationFrame(this.viewer.draw),this},_mutateFeaturePropertiesForHighlight:function(e,n){O.each(n,i=>{const o=this._featureOpacity[e][i.featureType];if(!o)return;var c={datalen:o.length,annotationId:e,fillOpacity:this._globalAnnotationFillOpacity,highlightannot:this._highlightAnnotation,highlightelem:this._highlightElement,hideannot:this._hideAnnotation,hideelem:this._hideElement};if(O.isMatch(i._lastFeatureProp,c))return;const g=new Array(o.length),d=new Array(o.length);for(let u=0;u<o.length;u+=1){const h=o[u].id,F=o[u].fillOpacity*this._globalAnnotationFillOpacity,y=o[u].strokeOpacity;this._hideAnnotation&&e===this._hideAnnotation&&h===this._hideElement?(g[u]=0,d[u]=0):!this._highlightAnnotation||!this._highlightElement&&e===this._highlightAnnotation||this._highlightElement===h?(g[u]=F,d[u]=y):(g[u]=F*.25,d[u]=y*.25)}i.updateStyleFromArray("fillOpacity",g),i.updateStyleFromArray("strokeOpacity",d),i._lastFeatureProp=c});const t=this._annotations[e].overlays||null;t&&O.each(t,i=>{const o=this.viewer.layers().find(c=>c.id()===i.id);if(o){let c=(i.opacity||1)*this._globalAnnotationOpacity;this._highlightAnnotation&&e!==this._highlightAnnotation&&(c=c*.25),o.opacity(c)}})},setBounds:function(e){var n=this.viewer.zoom(),t=this.viewer.bounds(),i=this.viewer.zoomRange();O.each(e||this._annotations,o=>{o.options.fetch&&o.annotation.setView&&o.annotation.setView(t,n,i.max,void 0,this.sizeX,this.sizeY)})},removeAnnotation:function(e){e.off("g:fetched",null,this),this.trigger("g:mouseResetAnnotation",e),O.has(this._annotations,e.id)&&(O.each(this._annotations[e.id].features,n=>{n._ownLayer?n.layer().map().deleteLayer(n.layer()):this.featureLayer.deleteFeature(n)}),O.each(this._annotations[e.id].overlays,n=>{const t=this.viewer.layers().filter(i=>i.id()===n.id);O.each(t,i=>{this.trigger("g:removeOverlayAnnotation",n,i),this.viewer.deleteLayer(i)})}),delete this._annotations[e.id],delete this._featureOpacity[e.id],this._countDrawnImageOverlays()===0&&this.getUnclampBoundsForOverlay()&&(this.viewer.clampBoundsY(!0),this.viewer.clampBoundsX(!0)),this.viewer.scheduleAnimationFrame(this.viewer.draw))},_mergeRegions(e,n){return!e||!e.length||e.length<2||e===[-1,-1,-1,-1]?n:(e.length===4?e=[e[0],e[1],e[0]+e[2],e[1],e[0]+e[2],e[1]+e[3],e[0],e[1]+e[3]]:e.length===6&&(e=[e[0]-e[3],e[1]-e[4],e[0]+e[3],e[1]-e[4],e[0]+e[3],e[1]+e[4],e[0]-e[3],e[1]+e[4]]),n.length===4?n=[n[0],n[1],n[0]+n[2],n[1],n[0]+n[2],n[1]+n[3],n[0],n[1]+n[3]]:n.length===6&&(n=[n[0]-n[3],n[1]-n[4],n[0]+n[3],n[1]-n[4],n[0]+n[3],n[1]+n[4],n[0]-n[3],n[1]+n[4]]),e.length===2&&n.length===2&&(n=[n[0],n[1],-1,-1]),e.concat([-1,-1]).concat(n))},drawRegion:function(e,n,t){let i,o;e&&e.model&&e.add!==void 0&&(n=e.mode,t=e.add,i=e.submitCtrl,o=e.event,e=e.model),e=e||new mn.Model;const c=["polygon","line","point","rectangle"].includes(n)?n:n==="polyline"?"line":o?n:"rectangle";return this.startDrawMode(c,{trigger:!1,signalModeChange:!0}).then(g=>{var d=g[0];let u="-1,-1,-1,-1";switch(n){case"point":u=[Math.round(d.center[0]),Math.round(d.center[1])];break;case"line":u=d.points.map(([v,L,I])=>[Math.round(v),Math.round(L)]).flat(),u=u.slice(0,4),u.push(-2),u.push(-2),u.push(-2),u.push(-2);break;case"polyline":for(u=d.points.map(([v,L,I])=>[Math.round(v),Math.round(L)]).flat(),u.push(-2),u.push(-2);u.length>0&&u.length<=6;)u.push(-2),u.push(-2);break;case"polygon":for(u=d.points.map(([v,L,I])=>[Math.round(v),Math.round(L)]).flat();u.length>0&&u.length<=6;)u.push(u[0]),u.push(u[1]);break;default:var h=Math.round(d.center[0]-d.width/2),F=Math.round(d.center[1]-d.height/2),y=Math.round(d.width),b=Math.round(d.height);u=[h,F,y,b];break}return t&&(u=this._mergeRegions(e.get("value"),u)),e.set("value",u,{trigger:!0}),ie.trigger("li:drawRegionUpdate",{values:u,submit:i,originalEvent:o}),e.get("value")})},clearRegion:function(e){e&&e.set("value",[-1,-1,-1,-1],{trigger:!0})},startDrawMode:function(e,n){var t=this.annotationLayer,i=[],o=[],c=fn.Deferred(),g;return t.geoOff(window.geo.event.annotation.mode),t.mode(null),t.geoOff(window.geo.event.annotation.state),n=O.defaults(n||{},{trigger:!0}),n.keepExisting||t.removeAllAnnotations(),t.geoOn(window.geo.event.annotation.state,d=>{if(d.annotation.state()!==window.geo.annotation.state.done)return;t.geoOff(window.geo.event.annotation.mode);const u={};t.currentBooleanOperation&&(u.currentBooleanOperation=t.currentBooleanOperation()),g=Be(d.annotation),g.id||(g.id=Ye()),i.push(g),o.push(d.annotation),n.trigger&&ie.trigger("g:annotationCreated",g,d.annotation,u),t.removeAllAnnotations(),t.geoOff(window.geo.event.annotation.state),c.resolve(i,o,u)}),t.mode(e,void 0,n.modeOptions),t.geoOn(window.geo.event.annotation.mode,d=>{t.geoOff(window.geo.event.annotation.state),t.geoOff(window.geo.event.annotation.mode),n.signalModeChange&&ie.trigger("li:drawModeChange",{event:d}),c.reject()}),c.promise()},setGlobalAnnotationOpacity:function(e){return this._globalAnnotationOpacity=e,this.featureLayer&&this.featureLayer.opacity(e),Object.values(this._annotations).forEach(n=>n.features.forEach(t=>{t._ownLayer&&t.layer().opacity(e)})),O.each(this._annotations,n=>{O.each(n.overlays,t=>{const i=this.viewer.layers().find(o=>o.id()===t.id);if(i){const o=t.opacity||1;i.opacity(e*o)}})}),this},setGlobalAnnotationFillOpacity:function(e){return this._globalAnnotationFillOpacity=e,this.featureLayer&&(O.each(this._annotations,(n,t)=>{const i=n.features;this._mutateFeaturePropertiesForHighlight(t,i)}),this.viewer.scheduleAnimationFrame(this.viewer.draw)),this},_setEventTypes:function(){var e=window.geo.event.feature;this._eventTypes={[e.mousedown]:"g:mouseDownAnnotation",[e.mouseup]:"g:mouseUpAnnotation",[e.mouseclick]:"g:mouseClickAnnotation",[e.mouseoff]:"g:mouseOffAnnotation",[e.mouseon]:"g:mouseOnAnnotation",[e.mouseover]:"g:mouseOverAnnotation",[e.mouseout]:"g:mouseOutAnnotation"}},_onMouseFeature:function(e,n,t){var i=e.data.properties||{},o;if(this._eventTypes||this._setEventTypes(),i.element&&i.annotation)o=this._eventTypes[e.event],o&&this.trigger(o,i.element,i.annotation,e);else if(n&&t&&(o=this._eventTypes[e.event],o)){const c=o+"Overlay";this.trigger(c,n,t,e)}},_guid:Ye}};const Xe=Object.freeze(Object.defineProperty({__proto__:null,geojs:wn},Symbol.toStringTag,{value:"Module"})),Ke={};for(var pe in girder.plugins.large_image.views.imageViewerWidget){const a=girder.plugins.large_image.views.imageViewerWidget[pe];if(Object.keys(Je).forEach(function(e){a.prototype[e]=Je[e]}),Xe[pe]){const e=Xe[pe](a);Object.keys(e).forEach(function(n){a.prototype[n]=e[n]})}Ke[pe]=a}const vn=Object.freeze(Object.defineProperty({__proto__:null,annotations:on,collections:sn,models:un,views:Object.freeze(Object.defineProperty({__proto__:null,ConfigView:K,HierarchyWidget:qe,ItemListWidget:Qe,ViewerWidget:Ke},Symbol.toStringTag,{value:"Module"}))},Symbol.toStringTag,{value:"Module"})),Cn=girder.views.widgets.SearchFieldWidget,{registerPluginNamespace:Ln}=girder.pluginUtils;Ln("large_image_annotation",vn),Cn.addMode("li_annotation_metadata",["item"],"Annotation Metadata search",'You can search specific annotation metadata keys by adding "key:<key name>" to your search.  Otherwise, all primary metadata keys are searched.  For example "key:quality good" would find any items with annotations that have attributes with a key named quality (case sensitive) that contains the word "good" (case insensitive) anywhere in its value.')});
//# sourceMappingURL=girder-plugin-large-image-annotation.umd.cjs.map
